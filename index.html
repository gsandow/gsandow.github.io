<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
    <link href='//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  



<link href="/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/stylesheet/main.css" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="博學   慎思   笃行">
<meta property="og:type" content="website">
<meta property="og:title" content="听雨阁">
<meta property="og:url" content="gsandow.github.io/index.html">
<meta property="og:site_name" content="听雨阁">
<meta property="og:description" content="博學   慎思   笃行">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="听雨阁">
<meta name="twitter:description" content="博學   慎思   笃行">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> 听雨阁 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-70294115-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?0f24b8759b65280643922c9035ac6bdf";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <div class="container one-column 
   page-home 
">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">听雨阁</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">stay hungry, stay foolish</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分類
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            標籤
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            關於
          </a>
        </li>
      

      
      
        <li class="menu-item menu-item-search">
          <a href="#" class="st-search-show-outputs">
            
              <i class="menu-item-icon fa fa-search icon-next-search"></i> <br />
            
            檢索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'MA224RsRYTYmje5Y13_h','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          
  <section id="posts" class="posts-expand">

    

    
    

    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/love_in_life/" itemprop="url">
                  大话西游
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2015-11-22T12:22:44+08:00" content="2015-11-22">
              2015-11-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分類於
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/movie/" itemprop="url" rel="index">
                    <span itemprop="name">movie</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/love_in_life/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="love_in_life/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>多少年之后才明白，那个转身究竟有多难</p>
<iframe src="http://www.tudou.com/programs/view/html5embed.action?type=0&code=xPY8Oan1SDk&lcode=&resourceId=0_06_05_99" allowtransparency="true" allowfullscreen="true" allowfullscreeninteractive="true" scrolling="no" border="0" frameborder="0" style="width:100%;height:450px;"></iframe>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/In_Bruges/" itemprop="url">
                  杀手没有假期
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2015-11-22T12:12:07+08:00" content="2015-11-22">
              2015-11-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分類於
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/movie/" itemprop="url" rel="index">
                    <span itemprop="name">movie</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/In_Bruges/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="In_Bruges/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>看完此电影最终让我觉得做人一定要有原则，守诺言，虽然自己现在还做的不好，但我相信以后一定会做到。不失信于人，不做围背原则的事。</p>
<p>论崇高：天之生人，不是要我们做卑鄙下流的動物，它带我们到生活中来，要我们做万物的观光者，所以它一开始便在我们心中种下一种热情-对一切伟大的比我们更神圣的事情的渴望。</p>
<p>每次读到这句话都深有感觸，这使得自己不要忘记曾经拋棄甚至决裂的那一类人，那一类品行十分差的人，并且也提醒自己不要变成那种下流的人，变成品行不端的人。我心中永远没有任何齷齪之事，永远光明正大。</p>
<p>永远不违背自己的原则永远要遵守诺言</p>
<p><img src="http://7xndvx.com1.z0.glb.clouddn.com/in_bruges.jpg" alt="做人要有原则"><br><img src="http://7xndvx.com1.z0.glb.clouddn.com/in_bruges1.jpg" alt="为此可以死"></p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/the-god-father/" itemprop="url">
                  教父
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2015-11-22T10:12:48+08:00" content="2015-11-22">
              2015-11-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分類於
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/movie/" itemprop="url" rel="index">
                    <span itemprop="name">movie</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/the-god-father/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="the-god-father/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p><img src="/images/thegodfathe_2.jpg" alt="海报"><img src="/images/thegodfathe_1r.jpg" alt="父子"><br>《教父》是派拉蒙影业公司出品的一部黑帮题材的电影，改编自马里奥·普佐的同名小说，由弗朗西斯·福特·科波拉执导，马龙·白兰度、阿尔·帕西诺等主演。虽是黑邦电影但它对家庭，对生活，对原则的做出了更好诠释。共有三部，前两部在IMDB电影排行榜中分别排第二与第三. 并且分别获得46，47届奥斯卡。</p>
<ul>
<li><strong>老教父维托·唐·科莱昂</strong>，家族的建立者，在意大利被don ciccio追杀被逼逃到美国，在美国认识了Genco（后来的军师）。老教父能做到这个地位。Genco起了巨大作用。与他的邻居clemenza（小偷） 后来成为老教父最得力的杀手。他有三个儿子桑尼，弗雷多，迈克。 老教父十分看重迈克，自从那次枪枪击案发生后便对弗雷多十分厌恶。一个女儿，此女人本十分讨厌，所以就不多说了。</li>
<li><strong>大儿子桑尼</strong>。 桑尼在家族中有自己的军团，除了脾气有一点暴之外，还是一个十分能干的人，十分注重家庭观念，对亲人特别关心。也十分好色，在书中有介绍。一个人如果无法沉着冷静的拥有一个暴脾气的话，是很容易被人利用的. </li>
<li><strong>二儿子费雷多</strong>， 他就是一个好孩子，善良，无心机。换句话说便是无能，自己连自己的女人都管不住，随随便便被打还不坑声,甘愿被人利用，懦夫一个。那次枪击事件发生后老教父便把他派出去再没让他回来。</li>
<li><strong>小儿子迈克</strong> 老教父最器重的便是他了。后来也成了老教父那般的人，强硬，冷静的人。他曾去海军参过军，参加过二战。因为枪杀警察在西西里避难的时候认识了啊波罗尼亚一位美丽的女神，看着好喜欢啊。经历两次婚姻是不幸福的，对于一个意大利人，家庭观念十分强的人更是如此，迈克也许就注定了不会幸福，这也许与他的性格有关吧,有什么心事都藏在心里。第二次的凯说真的很差，毫无家庭观念，而且最重要的是她不是一个西西里人。喜欢迈克的眼神，强硬，冷气逼人。<br><img src="/images/thegodfathe_5.jpg" alt="迈克1"><img src="/images/thegodfathe_7.jpg" alt="迈克2"></li>
</ul>
<hr>
<h2 id="说说自己的感悟">说说自己的感悟</h2><p>在别人看来即使你很坏，甚至是恶人，但是在家人看来，你永远是好丈夫，好父亲。不背叛家庭，你必须有义务，有责任去保护家里的每一个人不使之受伤，要知道这个世界并不是你一个人在奋斗，也不是为了自己奋斗，为了自己所爱的人，为了自己所爱的人能够幸福。现在也必须做事考虑后果，要对别人负责，对自己负责。</p>
<h2 id="speak_softely_love">speak softely love</h2><p>是我最喜欢的一首歌，也许是因为自己在心情低落的时候看的这部电影，而其中的音乐每次听着都特别伤心，特别心痛。</p>
<iframe src="http://www.tudou.com/programs/view/html5embed.action?type=0&code=7lqAMEScZS0&lcode=&resourceId=418557855_06_05_99" allowtransparency="true" allowfullscreen="true" allowfullscreeninteractive="true" scrolling="no" border="0" frameborder="0"></iframe>

<h2 id="一些经典语录">一些经典语录</h2><p>Behind every great fortune,there is a crime 财富背后都是罪恶</p>
<p>Don’t hate your enemy, or you will make wrong judgment.不要恨你的敌人，那样会让你做错误的决定</p>
<p>keep your friends close, but your enemies closer，与你的朋友保持亲近，但要与你的敌人更亲近</p>
<p>Don’t let anybody know what you are thinking. 不要让别人知道你在想什么</p>
<p>Never tell anybody outside the family what you are thinking again 不要让家庭以外的人知道你在想什么</p>
<p>Great men are not born great,they grow great 伟大的人不是天生的，而是后天形成的</p>
<p>You make the choice, and this is your price.你每做一个决定，就有代价</p>
<p>Everything I do with my power, including something criminal, I just want to protect my family and my friends .<br>我用我的权力做的每一件事（包括犯罪），仅仅是想保护我的家庭和我的朋友</p>
<p>I don’t care what you did is right or wrong, I want you know only me have the right to make decision, cause I am the godfather until my death.  我并不关心你做的对还是错，我只想要你知道只有我才有权做出决定，因为直到我死之前都是教父</p>
<p>I will never do anything guilty. 我从来都没有感觉到愧疚</p>
<p>Do you spend time with your family? Good. Because a man that doesn’t spend time with his family can never be a real man.  </p>
<p>I spent my whole life trying not to be careless. Women and children can be careless. But not men.我试着不去精心，只有女人与小孩才可以精心。</p>
<p>I’m gonna make him an offer he can’t refuse. 我出的价格他是无法拒绝的</p>
<p>I never wanted this for you. I work my whole life — I don’t apologize — to take care of my family, and I refused to be a fool, dancing on the string held by all those big shots. I don’t apologize — that’s my life — but I thought that, that when it was your time, that you would be the one to hold the string. Senator </p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/NFS/" itemprop="url">
                  NFS网络文件系统
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2015-11-22T09:30:40+08:00" content="2015-11-22">
              2015-11-22
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分類於
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/NFS/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="NFS/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="NFS网络文件系统">NFS网络文件系统</h1><h2 id="NFS_系统介绍">NFS 系统介绍</h2><p>network file sysctem 是网络文件系统，它的主要功能是通过网络让i同的主机系统之间可以共享文件或目录，NFS客户端一般为应用服务器，RPC (remote procedure call) 是能使客户端执行其他系统中程序的一种机制。NFS本身是没有提供信息传输的协议和功能的，但NFS却能让我们通过网络进行资料的分享，这是因为NFS使用了一些其它的传输协议。而这些传输协议用到这个RPC功能的。。所以只要用到NFS的地方都要启动RPC服务，不论是NFS SERVER或者NFS CLIENT。这样SERVER和CLIENT才能通过RPC来实现PROGRAM PORT的对应。可以这么理解RPC和NFS的关系：NFS是一个文件系统，而RPC是负责负责信息的传输。大企业： MFS, FASTDFS , GLUSTERFS, CEPH</p>
<p>在客户端与服务端都需要安装NFS与RPC<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sed -i <span class="string">'s/keepcache=0/keepcache=1/g'</span> /etc/yum.conf</span><br><span class="line">$ sed -n  <span class="string">'1,4p'</span> /etc/yum.conf</span><br><span class="line">$ yum install nfs-utils rpcbind -y</span><br></pre></td></tr></table></figure></p>
<p>在服务端启动<code>rpcbind</code> 与<code>nfs</code>, 在客户端启动<code>rpcbind</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ /etc/init.d/nfs <span class="operator"><span class="keyword">start</span></span><br><span class="line">$ /etc/init.<span class="keyword">d</span>/rpcbind <span class="keyword">start</span></span></span><br></pre></td></tr></table></figure>
<h2 id="NFS_服务端配置">NFS 服务端配置</h2><p>NFS的常用目录</p>
<ul>
<li>/etc/exports    NFS服务的主要配置文件</li>
<li>/usr/sbin/exportfs    NFS服务的管理命令</li>
<li>/usr/sbin/shownmount 客户端的查看命令</li>
<li>/var/lib/nfs/etab     NFS分享出来的目录的完整权限设定值</li>
<li>/var/lib/nfs/xtab  记录曾经登录过的客户端信息</li>
</ul>
<h3 id="配置/etc/exprots">配置/etc/exprots</h3><p>&lt;输出目录&gt; [客户端1 选项（访问权限,用户映射,其他）] [客户端2 选项（访问权限,用户映射,其他）]</p>
<blockquote>
<p>目录： NFS系统中需要共享给客户机使用的目录<br>客户端：其中客户端可以指定IP或者指定网段，也可以指定载名中的主机。 （*）表示所有主机<br>选项用来设置输出目录的访问权限，用户映射</p>
<ol>
<li>选项： ro 只读， rw 读写</li>
<li>用户映射：<ul>
<li>all_squash: 将远程访问的所有普通用户及所属组映射为匿名用户或组(nfsnobody)</li>
<li>no_all_squash: </li>
<li>root_squash: 将root用户及所属组都映射为匿名用户或组（默认设置）</li>
<li>no_root_squash</li>
<li>anonuid=xxx: 将远程访问的所有用户都映射为匿名用户，并指定该用户为本地用户</li>
<li>anongid=xxx</li>
</ul>
</li>
<li>其它选项：<ul>
<li>secure: 限制客户端只能从小于1024的tcp/ip端连接nfs服务器（默认设置）</li>
<li>insecure： 大于1024</li>
<li>sync: 将数据同步写放内存缓存区与磁盘中，效率低。但保证数据一致性</li>
<li>async:先保存到内存缓存中，必要时写入磁盘</li>
<li>wdelay: 检查是否有相关的写操作，如果有则将这些写操作一起执行，（默认设置）</li>
<li>no_wdelay: 若有写操作则立即执行，与sync配合使用</li>
<li>subtree: 若输出目录是一个子目录，则nfs服务器将检查其父目录的权限（默认设置）</li>
<li>nosubtree: 不检查父目录的权限。这样可以提高效率</li>
</ul>
</li>
</ol>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/exports</span><br><span class="line">/data <span class="number">172.16</span>.<span class="number">1.0</span>/<span class="number">24</span>(rw, sync)</span><br></pre></td></tr></table></figure>
<p>创建文件修改权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data</span><br><span class="line">chown -R nfsnobody,nfsnobody /data</span><br></pre></td></tr></table></figure>
<p>然后平滑重启， </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ /etc/init.d/rpcbind reload</span><br><span class="line">$ /etc/init.d/nfs reload</span><br><span class="line">$ exportfs</span><br><span class="line">/data		<span class="number">172.16</span>.<span class="number">1.0</span>/<span class="number">24</span></span><br><span class="line"></span><br><span class="line">$ cat /var/lib/nfs/etab</span><br><span class="line">/data	<span class="number">172.16</span>.<span class="number">1.0</span>/<span class="number">24</span>(rw,sync,wdelay,hide,nocrossmnt,secure,root_squash,no_all_squash,no_subtree_check,secure_locks,acl,anonuid=<span class="number">65534</span>,anongid=<span class="number">65534</span>,sec=sys,rw,root_squash,no_all_squash)</span><br><span class="line"></span><br><span class="line">$ service rpcbind status</span><br><span class="line">rpcbind (pid  <span class="number">1376</span>) is running...</span><br><span class="line"></span><br><span class="line">$ service nfs status</span><br><span class="line">rpc.svcgssd is stopped</span><br><span class="line">rpc.mountd (pid <span class="number">1583</span>) is running...</span><br><span class="line">nfsd (pid <span class="number">1599</span> <span class="number">1598</span> <span class="number">1597</span> <span class="number">1596</span> <span class="number">1595</span> <span class="number">1594</span> <span class="number">1593</span> <span class="number">1592</span>) is running...</span><br><span class="line">rpc.rquotad (pid <span class="number">1578</span>) is running...</span><br></pre></td></tr></table></figure>
<p>然后可以用showmount 来时候NFS的共享状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ showmount <span class="operator">-e</span> <span class="comment">#默认查看自己共享服务</span></span><br><span class="line">Export list <span class="keyword">for</span> NFS01:</span><br><span class="line">/data <span class="number">172.16</span>.<span class="number">1.0</span>/<span class="number">24</span></span><br><span class="line"></span><br><span class="line">$ showmount <span class="operator">-a</span>  <span class="comment">#查看已经与客户端连接上的目录信息</span></span><br><span class="line">All mount points on NFS01:</span><br></pre></td></tr></table></figure></p>
<h2 id="NFS客户端">NFS客户端</h2><p>客户端仅需要启动rpcbind，然后可以用showmount来查询nfs的共享状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ showmount <span class="operator">-e</span> <span class="number">172.16</span>.<span class="number">1.31</span>  </span><br><span class="line">Export list <span class="keyword">for</span> <span class="number">172.16</span>.<span class="number">1.31</span>:</span><br><span class="line">/data <span class="number">172.16</span>.<span class="number">1.0</span>/<span class="number">24</span></span><br></pre></td></tr></table></figure>
<p>mount 语法<code>mount NFS服务器IP:共享目录 本地挂载点目录</code><br>现在我们把客户端的/mnt挂载到服务器的/data/test/上<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ mount -t <span class="number">172.16</span>.<span class="number">1.31</span>:/data/<span class="built_in">test</span>/ /mnt/</span><br><span class="line">$ mount |grep nfs</span><br><span class="line">sunrpc on /var/lib/nfs/rpc_pipefs <span class="built_in">type</span> rpc_pipefs (rw)</span><br><span class="line"><span class="number">172.16</span>.<span class="number">1.31</span>:/data/<span class="built_in">test</span>/ on /mnt <span class="built_in">type</span> nfs (rw,vers=<span class="number">4</span>,addr=<span class="number">172.16</span>.<span class="number">1.31</span>,clientaddr=<span class="number">172.16</span>.<span class="number">1.8</span>)</span><br></pre></td></tr></table></figure></p>
<p>这里我要说一下，如果客户端需要使用普通用户在共享目录写文件，可以在服务器里的共享目录下一个字目录给777权限，普通用户创建的文件的属主与组与该普通用户相同<br>设定权限可以这样<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t nfs -o noatime,nodiratime,nosuid,noexec,nodev,rsize=<span class="number">131072</span>,wsize=<span class="number">131072</span>  <span class="number">10.0</span>.<span class="number">0.7</span>:/data  /mnt</span><br></pre></td></tr></table></figure></p>
<p>查看挂载信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ df -h</span><br><span class="line">Filesystem          Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda2           <span class="number">6.9</span>G  <span class="number">1.5</span>G  <span class="number">5.1</span>G  <span class="number">23</span>% /</span><br><span class="line">tmpfs               <span class="number">238</span>M     <span class="number">0</span>  <span class="number">238</span>M   <span class="number">0</span>% /dev/shm</span><br><span class="line">/dev/sda1           <span class="number">190</span>M   <span class="number">36</span>M  <span class="number">145</span>M  <span class="number">20</span>% /boot</span><br><span class="line"><span class="number">172.16</span>.<span class="number">1.31</span>:/data/  <span class="number">6.9</span>G  <span class="number">3.7</span>G  <span class="number">2.9</span>G  <span class="number">57</span>% /data/upload</span><br></pre></td></tr></table></figure></p>
<h2 id="内核性能相关优化">内核性能相关优化</h2><p>1、/proc/sys/net/core/rmem_default<br>   该文件指定了接收套接字缓冲区大小的缺省值（以字节为单位），缺省设置：124928<br>2、/proc/sys/net/core/rmem_max<br>   该文件指定了接收套接字缓冲区大小的最大值（以字节为单位），缺省设置：124928<br>3、/proc/sys/net/core/wmem_default<br>   该文件指定了发送套接字缓冲区大小的缺省值（以字节为单位），缺省设置：124928<br>4、/proc/sys/net/core/wmem_max<br>   该文件指定了发送套接字缓冲区大小的最大值（以字节为单位），缺省设置：124928<br>对上述文件的具体内核优化：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ cat &gt;&gt;/etc/sysctl.conf&lt;&lt;EOF</span><br><span class="line">net.core.wmem_default = <span class="number">8388608</span></span><br><span class="line">net.core.rmem_default = <span class="number">8388608</span></span><br><span class="line">net.core.wmem_max = <span class="number">16777216</span></span><br><span class="line">net.core.rmem_max = <span class="number">16777216</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">$ sysctl -p</span><br></pre></td></tr></table></figure>
<h2 id="相关命令">相关命令</h2><blockquote>
<ol>
<li>exportfs<br>在启动NFS后，如果修改了/etc/exports，就需要重启nfs，这时候可以用exportfs命令来使之立刻生效 <code>exportfs -rv</code> 相当于 `/etc/init.d/nfs reload<ul>
<li>-a 全部挂找或卸载</li>
<li>-r 重新读取/etc/exports中的信息，并同步更新/etc/exports, /var/lib/nfs/xtab</li>
<li>-u 卸载单一目录（和a一起使用为卸载所有/etc/exports文件中的目录)</li>
<li>-v 在export的时候， 将详细的信息输出到屏幕上 </li>
</ul>
</li>
<li>nfsstat  查看NFS的运行状态，</li>
<li>rpcinfo  查看RPC执行信息，可以用于检测RPC运行情况的工具</li>
<li>showmount<ul>
<li>-a 显示已经于客户端连接上的目录信息</li>
<li>-e IP或hostname显示此IP地址分享出来的目录</li>
</ul>
</li>
<li>netstat</li>
<li>mount 客户端挂载NFS共享目录可选参数 <code>man -a mount</code><ul>
<li>soft 当服务端没回应时，会在timeout后重新连接，会回错误信息</li>
<li>hard 当服务端没回应时持续在后台尝试连接</li>
<li>intr 正在进行NFS请求时，允许用键盘中断</li>
<li>nointr  不允许键盘中断</li>
<li>timeo 请求过期时间 单位为秒</li>
<li>bg 第一次请求不成功，第二次的mount将放到后台执行</li>
<li>fg 一直在前台发送请求</li>
<li>proto=tcp|udp 修改使用TCP协议还是UDP协议来传输NFS的数据</li>
<li>default   ， hard nointr</li>
<li>rsize  设置块大小(bytes) </li>
<li>wsize 写操作的大小，这两个操作会影响服务器客户端NFS缓存大小</li>
</ul>
</li>
</ol>
</blockquote>
<p>NFS优点<br>1简单，容易上手，容易掌握。<br>2NFS文件系统内数据是在文件系统之上的，即数据是能看得见的。<br>3部署快速，维护简单方便，且可控，满足需求就是最好的。<br>4可靠从软件层面上看，数据可靠性高，经久耐用。数据是在文件系统之上的。<br>5服务非常稳定<br>NFS局限：<br>1、 局限性是存在单点故障，如果nfs server宕机了所有客户端都不能访问共享目录，这个在后期通过负载均衡及高可用方案弥补<br>2、 在大数据高并发的场合，NFS效率/性能有限<br>3、 客户端认证时基于ip和主机名、权限时，根据id识别，安全性一般（用于内网问题不大）<br>4、 NFS数据时明文的，NFS本身对数据完整性不作验证<br>5、 多台客户机器挂载一个NFS服务器时，连接管理维护麻烦（耦合度高），尤其是NFS服务端出问题后，所有NFS客户端都挂掉状态</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/the-three-musketeers/" itemprop="url">
                  linux 三剑客
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2015-11-17T23:29:26+08:00" content="2015-11-17">
              2015-11-17
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分類於
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/the-three-musketeers/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="the-three-musketeers/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="Linux_the_three_musketeers">Linux the three musketeers</h1><p>linux中三剑客分别是grep, sed, awk. 他们都支持正则表达式，在文本处理上非常高效。现在就此三个命令做简单介绍</p>
<p>[toc]</p>
<h2 id="grep,_egrep,_fgrep">grep, egrep, fgrep</h2><p>egrep, fgrep 是grep的扩展，其主要功能便是打印符合样式的行</p>
<p>其控制打印的行数的参数有</p>
<ul>
<li>-A NUM, –after-context=NUM    Print NUM lines of trailing context after matching lines.</li>
<li>-B NUM, –before-context=NUM    Print NUM lines of leading context before matching lines.</li>
<li>-C NUM, –context=NUM    Print NUM lines of output context.</li>
</ul>
<p>也就是说A 打印匹配到样式及其后几行，B 打印匹配到样式及其前几行，C 便是匹配到样式的上下文下面仅以A举例，BC，同理</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ grep -A2 <span class="string">"sandow"</span> /etc/passwd</span><br><span class="line">sandow:x:<span class="number">500</span>:<span class="number">500</span>::/home/sandow:/bin/bash</span><br><span class="line">oldboy:x:<span class="number">501</span>:<span class="number">501</span>::/home/oldboy:/bin/bash</span><br><span class="line">oldgirl:x:<span class="number">502</span>:<span class="number">502</span>::/home/oldgirl:/bin/bash</span><br></pre></td></tr></table></figure>
<p>控制匹配结果的参数有：</p>
<ul>
<li>-i ,–ignore-case.  Ignore case distinctions 顾名思义，便是忽略大小写</li>
<li>-v, –inver-match.  Invert the sense of matching, to select non-matching lines 反向匹配</li>
<li>-E, –extended-regexp. 扩展正则表达式，相当于egrep</li>
<li>-F, –fixed-strings, –fixed-regexp, 把范本样式视为固定字符串的列表，相当于fgrep</li>
<li>-o, –only-matching 只显示匹配到的那部分</li>
</ul>
<p>控制输出结果的参数：</p>
<ul>
<li>-c, –count， 仅统计匹配到的结果，匹配到两个就会返回2</li>
<li>-n, –line-number ,  显示匹配到行的行数</li>
<li>–color=auto 把匹配到的显示高亮显示</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ ifconfig eth0</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr <span class="number">00</span>:<span class="number">0</span>C:<span class="number">29</span>:<span class="number">1</span>E:<span class="number">00</span>:<span class="number">6</span>F  </span><br><span class="line">          inet addr:<span class="number">10.0</span>.<span class="number">0.17</span>  Bcast:<span class="number">10.0</span>.<span class="number">0.255</span>  Mask:<span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line">          inet6 addr: fe80::<span class="number">20</span>c:<span class="number">29</span>ff:fe1e:<span class="number">6</span>f/<span class="number">64</span> Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:<span class="number">1500</span>  Metric:<span class="number">1</span></span><br><span class="line">          RX packets:<span class="number">2410</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> frame:<span class="number">0</span></span><br><span class="line">          TX packets:<span class="number">649</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> carrier:<span class="number">0</span></span><br><span class="line">          collisions:<span class="number">0</span> txqueuelen:<span class="number">1000</span> </span><br><span class="line">          RX bytes:<span class="number">229147</span> (<span class="number">223.7</span> KiB)  TX bytes:<span class="number">135613</span> (<span class="number">132.4</span> KiB)</span><br><span class="line"></span><br><span class="line">$ ifconfig eth0|grep Bcast|egrep -o <span class="string">"[0-9.]*"</span></span><br><span class="line"><span class="number">10.0</span>.<span class="number">0.17</span></span><br><span class="line"><span class="number">10.0</span>.<span class="number">0.255</span></span><br><span class="line"><span class="number">255.255</span>.<span class="number">255.0</span></span><br></pre></td></tr></table></figure>
<p>grep 也可以指定目录，它会搜索目录下所有文件里的内容并输出匹配符合样式的行</p>
<h2 id="sed_stream_editor_for_filtering_and_transforming_text">sed stream editor for filtering and transforming text</h2><p>sed 批量的编辑文本，sed 擅长处理行。sed 可以删除(delete), 改变（change）, 添加(insert), 合并，交换文件中的数据行，或读入其它文件的数据到文件中，也可以替换(substuite) 它他其中的字符串。是一个非交互式的效率非常高的命令</p>
<p>###sed 参数</p>
<ul>
<li>-n, –quiet, –silent 只打印匹配到的行</li>
<li>-e script, 执行后面的命令</li>
<li>-f script-file, 执行后面文件中的命令</li>
</ul>
<p>语法<code>sed -e &#39;command1&#39; -e &#39;command2&#39; filename</code> 注意这个单引号并不是一成不变的，当在shell里需要引用变量时便可以用双引号</p>
<p>例如，删除sed.txt文件中第1到10行并且把magdre改为sandow 便可以这样</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sed <span class="operator">-e</span> <span class="string">'1,10d'</span> <span class="operator">-e</span> <span class="string">'s/magdre/sandow/g'</span>  sed.txt</span><br></pre></td></tr></table></figure>
<h3 id="位址">位址</h3><p>sed 的编辑指令分为位址(address)和指令 。 位址负责定位需要编辑的内容，指令负责编辑。其语法格式为 <code>[address1 [,address2]][function[argument]]</code></p>
<p>当没有位址时便会对所有文本处理，一个位址时位会处理该位置定位到的行，两个位址时便会处理从位址1到位址2的行数。当然如果使用正则表达式便是匹配字符的行咯。</p>
<table>
<thead>
<tr>
<th style="text-align:center">位址中的指令</th>
<th style="text-align:left">描述</th>
<th></th>
<th style="text-align:center">位址中的指令</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">$</td>
<td style="text-align:left">最后一行</td>
<td></td>
<td style="text-align:center">first~step</td>
<td style="text-align:left">从first开始步长为setp的行</td>
</tr>
<tr>
<td style="text-align:center">/regexp/</td>
<td style="text-align:left">用正则来匹配行</td>
<td></td>
<td style="text-align:center">0,addr2</td>
<td style="text-align:left">匹配到前addr2行</td>
</tr>
<tr>
<td style="text-align:center">addr1,+n</td>
<td style="text-align:left">从addr1开始后n行</td>
<td></td>
<td style="text-align:center">addr1,~n</td>
<td style="text-align:left">这个不重要</td>
</tr>
</tbody>
</table>
<p>看起来很复杂吧，先来几个例子</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="operator">-e</span> <span class="string">"hello\nmy name is sandow\nmy bolg is magdre.github.io"</span>  &gt;test.txt</span><br><span class="line"></span><br><span class="line">$ sed -n <span class="string">'$p'</span> test.txt</span><br><span class="line">my bolg is magdre.github.io</span><br><span class="line"></span><br><span class="line">$ sed -n <span class="string">'/sandow/p'</span> test.txt </span><br><span class="line">my name is sandow</span><br></pre></td></tr></table></figure>
<h3 id="指令">指令</h3><p>上面看到很多d , p, g, s 等这些都是什么意思呢，他们都需要函数，那么接下来就来说说他们到底代表的什么意思</p>
<table>
<thead>
<tr>
<th style="text-align:center">指令</th>
<th style="text-align:left">描述</th>
<th></th>
<th style="text-align:center">指令</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">=</td>
<td style="text-align:left">打印行数</td>
<td></td>
<td style="text-align:center">r</td>
<td style="text-align:left">从文件中记取数据</td>
</tr>
<tr>
<td style="text-align:center">a\</td>
<td style="text-align:left">在当前行下追加数据</td>
<td></td>
<td style="text-align:center">i\</td>
<td style="text-align:left">在当前行上追加数据</td>
</tr>
<tr>
<td style="text-align:center">c\</td>
<td style="text-align:left">把选定行改为新文本</td>
<td></td>
<td style="text-align:center">d</td>
<td style="text-align:left">删除所选择的行</td>
</tr>
<tr>
<td style="text-align:center">s</td>
<td style="text-align:left">替换指定字符</td>
<td></td>
<td style="text-align:center">q</td>
<td style="text-align:left">退出sed编辑</td>
</tr>
<tr>
<td style="text-align:center">n</td>
<td style="text-align:left">读取下一个输入行，用下一个命令处理新的行</td>
<td></td>
<td style="text-align:center">N</td>
<td style="text-align:left">这个百度去吧</td>
</tr>
<tr>
<td style="text-align:center">h</td>
<td style="text-align:left">复制pattern space到内存缓存区</td>
<td></td>
<td style="text-align:center">H</td>
<td style="text-align:left">追加到缓存区</td>
</tr>
<tr>
<td style="text-align:center">g</td>
<td style="text-align:left">获取缓存区内容替换pattern space</td>
<td></td>
<td style="text-align:center">G</td>
<td style="text-align:left">追加到 pattern space后</td>
</tr>
<tr>
<td style="text-align:center">p</td>
<td style="text-align:left">打印当前pattern space</td>
<td></td>
<td style="text-align:center">P</td>
<td style="text-align:left">打印模版块的第一行</td>
</tr>
<tr>
<td style="text-align:center">: label</td>
<td style="text-align:left">建立参照位址</td>
<td></td>
<td style="text-align:center">b label</td>
<td style="text-align:left">将指令跳到参照位址</td>
</tr>
<tr>
<td style="text-align:center">w</td>
<td style="text-align:left">写入文件</td>
<td></td>
</tr>
</tbody>
</table>
<p>当需要对一个位址执行多个指令时需要用{}来括起来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">addr&#123;</span><br><span class="line">commend1</span><br><span class="line">commend2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>来来来，例子给你形象说明</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ cat test.txt</span><br><span class="line">hello</span><br><span class="line">my name is sandow</span><br><span class="line">my bolg is magdre.github.io</span><br><span class="line"></span><br><span class="line">$ sed <span class="string">'2a I am a gentleman'</span> test.txt</span><br><span class="line">hello</span><br><span class="line">my name is sandow</span><br><span class="line">I am a gentleman</span><br><span class="line">my bolg is magdre.github.io</span><br><span class="line"></span><br><span class="line">$ sed <span class="operator">-e</span> <span class="string">'2c\I am a gentleman'</span> <span class="operator">-e</span> <span class="string">'1i\stay hungry stay foolish'</span> test.txt</span><br><span class="line">stay hungry stay foolish</span><br><span class="line">hello</span><br><span class="line">I am a gentleman</span><br><span class="line">my bolg is magdre.github.io</span><br></pre></td></tr></table></figure>
<p>这里有一个”!” 其功能很特别需要在这里说下，如下例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centOs ~]<span class="comment"># sed '/sandow/!d' test.txt </span></span><br><span class="line">my name is sandow</span><br></pre></td></tr></table></figure>
<p>这时会删除除匹配到的那行外的所有行</p>
<p><strong>替换字符举例</strong><br> <code>s/regexp/replacement/[flag]</code>  用正则表达式来匹配，匹配到后用replacement来做替换 在replacement里可以用\1到\9来输出前面regexp里的子表达式匹配到的内容。 另在replacement 里可以用 ‘&amp;’ 来代表前面所匹配到的内容。我们用flag来控制如何替换</p>
<ul>
<li>g 代表替换所有匹配到的内容</li>
<li>num 当为数字为是从第几个匹配到的内容开始替换</li>
<li>p  标准输出</li>
<li>w filename 替换后输入名为filename的文件中</li>
<li>空 仅替换第一个匹配到的内容<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ ifconfig eth0 | sed -nr <span class="string">'2s/.*:(.*) .*:(.*) .*:(.*)/\1 \2 \3/gp'</span></span><br><span class="line"><span class="number">10.0</span>.<span class="number">0.17</span>  <span class="number">10.0</span>.<span class="number">0.255</span>  <span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line"></span><br><span class="line">$ ifconfig eth0 | sed -nr <span class="string">'/Bcast/s/.*:(.*) .*:(.*) .*:(.*)/\1 \2 \3/gp'</span></span><br><span class="line"><span class="number">10.0</span>.<span class="number">0.17</span>  <span class="number">10.0</span>.<span class="number">0.255</span>  <span class="number">255.255</span>.<span class="number">255.0</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>变形</strong><br>说实话这个不怎么用，所以只附上其英文解释<br><code>y/source/dest/</code>   Transliterate  the  characters  in  the  pattern space  which appear in source to the corresponding  character  in dest.</p>
<h3 id="sed_的小技巧">sed 的小技巧</h3><p><code>sed -n &#39;$=&#39; test.txt</code>    计算行数<br><code>ifconfig eth0 |sed 2q</code> 显示前两行内容<br><code>sed &#39;$!d&#39;</code> 或 ` sed -n ‘$p’  显示最后一行内容</p>
<h2 id="gawk_-_pattern_scanning_and_processing_language">gawk - pattern scanning and processing language</h2><p>awk这就是一门轻量级语言，也没必要去认真研习，awk能解决的python都可以搞定，所以现在仅简单介绍下便好。</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/ssh-keygen/" itemprop="url">
                  ssh-keygen及批量分发
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2015-11-15T21:08:53+08:00" content="2015-11-15">
              2015-11-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分類於
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/ssh-keygen/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="ssh-keygen/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="ssh_无密登录">ssh 无密登录</h1><p>当使用terminal，  ssh远程主机，每次都都需要输密码，今天就介绍下如何使用ssh而不需要每次都输密码，并且还可以实现批量分发（结合rsync或者ssh本身自带的scp）费话少说，let’s go。</p>
<h2 id="ssh_(sercure_shell_protocol)_是什么？">ssh (sercure shell protocol) 是什么？</h2><p>ssh 是专为远程登录会话和其他网络服务提供的安全协议，利用ssh协议可以有效的防止远程中信息的泄露。详情请参见<a href="www.baidu.com">百度</a>. </p>
<p>远程连接有两种方式</p>
<ol>
<li>基于口令的安全验证， 只要知道远程主机的贴与口令，就可以登录远程主机，</li>
<li>基于密匙的安全验证，使用密匙生成口令后每次登录目标主机都不需要再输密码，SSH密钥总是成双出现，一把公钥，一把私钥。公钥可以自由放在所需要连接的服务器上，而私钥必须稳妥保管好。在登录的时候，远程主机会向用户发送一段随机字符串（1024beytes) 用户用自己的私钥加密后，再发回来，远程主机用事先储存的公钥进行解密，如果成功，就证明用户是可信的。允许登录。这样做的好处就是不受中间人攻击。</li>
</ol>
<h2 id="ssh_keygen_密钥生成">ssh keygen 密钥生成</h2><p>我们使用<code>ssh-keygen</code>生成密匙。下面简单介绍下命令的语法</p>
<p>命令描述：ssh-keygen主要用来生成rsa keys （ssh 1） 或者生成ecdsa /rsa keys（ssh2).第一次输入命令会在家目录里创建一个隐藏目录<strong>.ssh</strong>并且在下面生成密钥文件，一个公钥一个密钥。 私钥名为<strong>~/.ssh/identity, ~/.ssh/ecdsa, ~/.ssh/id_dsa, ~/.ssh/id_rsa</strong> 其中一种这取决于ssh的版本，也可以使用<code>-f</code>来指定生成的文件名。公钥的文件名会在密钥文件名后加<strong>.pub</strong></p>
<p>参数：</p>
<ul>
<li>-b bits, 指定生成密钥的（768-2048）bite，默认是2048,</li>
<li>-C comment 增加备注</li>
<li>-f filename, 指定密钥文件名</li>
<li>-t type, 指定密钥的类型 rsa1 (ssh1); dsa ecdsa rsa (ssh2)</li>
</ul>
<p>玩github的朋友可能已经注意到上传到github时可以选择ssh方式，而且官网还有一个专门的教程<a href="https://help.github.com/articles/generating-ssh-keys/" target="_blank" rel="external">Generating SSH keys</a>其讲解基本与下面内容相似。</p>
<p>首先在客户端，生成密钥<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[sandow@NFS01 ~]$ ssh-keygen</span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file <span class="keyword">in</span> <span class="built_in">which</span> to save the key (/home/sandow/.ssh/id_rsa): </span><br><span class="line">Created directory <span class="string">'/home/sandow/.ssh'</span>.</span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /home/sandow/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved <span class="keyword">in</span> /home/sandow/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line"><span class="number">08</span>:<span class="number">48</span>:<span class="number">69</span>:<span class="number">77</span>:<span class="number">45</span>:<span class="number">14</span>:<span class="number">00</span>:<span class="number">29</span>:<span class="number">57</span>:a8:<span class="number">62</span>:<span class="number">3</span>e:<span class="number">39</span>:bd:<span class="number">57</span>:<span class="number">78</span> sandow@NFS01</span><br><span class="line">The key<span class="string">'s randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|  ...=o==.       |</span><br><span class="line">| .+.= .          |</span><br><span class="line">| ..=..           |</span><br><span class="line">|...  . .         |</span><br><span class="line">|o.o   o S        |</span><br><span class="line">| = . . E         |</span><br><span class="line">|  o . o          |</span><br><span class="line">|   . .           |</span><br><span class="line">|    .            |</span><br><span class="line">+-----------------+</span></span><br></pre></td></tr></table></figure></p>
<p>查看生成的文件,请记住这里每个文件的权限位，以后出问题很可能是这里的问题</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[sandow@NFS01 .ssh]$ ll</span><br><span class="line">total <span class="number">8</span></span><br><span class="line">-rw-------. <span class="number">1</span> sandow sandow <span class="number">1675</span> Nov <span class="number">11</span> <span class="number">11</span>:<span class="number">04</span> id_rsa</span><br><span class="line">-rw-r--r--. <span class="number">1</span> sandow sandow  <span class="number">394</span> Nov <span class="number">11</span> <span class="number">11</span>:<span class="number">04</span> id_rsa.pub</span><br></pre></td></tr></table></figure>
<p>这两个文件里面都是密钥，没什么好看的，反正也看不懂。那么接下来就需要把公钥，也就是<strong>id_rsa.pub</strong> 分发到每台服务机上</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[sandow@NFS01 .ssh]$ ssh-copy-id -i <span class="string">" -p 52113 sandow@172.16.1.41"</span></span><br><span class="line">The authenticity of host <span class="string">'[172.16.1.41]:52113 ([172.16.1.41]:52113)'</span> can<span class="string">'t be established.</span><br><span class="line">RSA key fingerprint is a9:5e:34:5c:4c:33:91:39:45:cd:6e:e9:7b:de:7c:c6.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added '</span>[<span class="number">172.16</span>.<span class="number">1.41</span>]:<span class="number">52113</span><span class="string">' (RSA) to the list of known hosts.</span><br><span class="line">sandow@172.16.1.41'</span>s password: </span><br><span class="line">Now try logging into the machine, with <span class="string">"ssh ' -p 52113 sandow@172.16.1.41'"</span>, and check <span class="keyword">in</span>:</span><br><span class="line"></span><br><span class="line">  .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line">to make sure we haven<span class="string">'t added extra keys that you weren'</span>t expecting.</span><br></pre></td></tr></table></figure>
<p>因为之前已经分发过一次所以这次就会提示已经存在。没分发过的不会出现这个提示的。接下来我们再使用<code>ssh -p 52113 172.16.1.41</code>时便不会再需要密码。注意这里那个用户生成的密钥便只能用那个用户来登录，登录对应的主机用户与当前客户端的用户一致，除非指定用户</p>
<p>有时候我们不想连接到服务器仅想执行一个命令就退出，可以这样写<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[sandow@NFS01 .ssh]$ ssh -p52113 <span class="number">172.16</span>.<span class="number">1.41</span> /sbin/ifconfig eth1</span><br><span class="line">eth1      Link encap:Ethernet  HWaddr <span class="number">00</span>:<span class="number">0</span>C:<span class="number">29</span>:<span class="number">69</span>:<span class="number">77</span>:D7  </span><br><span class="line">          inet addr:<span class="number">172.16</span>.<span class="number">1.41</span>  Bcast:<span class="number">172.16</span>.<span class="number">1.255</span>  Mask:<span class="number">255.255</span>.<span class="number">255.0</span></span><br><span class="line">          inet6 addr: fe80::<span class="number">20</span>c:<span class="number">29</span>ff:fe69:<span class="number">77</span>d7/<span class="number">64</span> Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:<span class="number">1500</span>  Metric:<span class="number">1</span></span><br><span class="line">          RX packets:<span class="number">6289</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> frame:<span class="number">0</span></span><br><span class="line">          TX packets:<span class="number">5443</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> carrier:<span class="number">0</span></span><br><span class="line">          collisions:<span class="number">0</span> txqueuelen:<span class="number">1000</span> </span><br><span class="line">          RX bytes:<span class="number">627464</span> (<span class="number">612.7</span> KiB)  TX bytes:<span class="number">548720</span> (<span class="number">535.8</span> KiB)</span><br></pre></td></tr></table></figure></p>
<p>因为远程连接执行命令风险很高，所以需要对远程连接加以一定的限制达到风险最低。下面有几种方案：</p>
<ol>
<li>sudo方案<br>在服务机上对远程用户授权（使用<code>visudo -e</code>) 然后再进行ssh 远程命令<br><code>ssh -t -p 52113 sandow@172.16.1.41 sudo /bin/cp hosts /etc/</code></li>
<li>suid<br>对需要执行的命令设置suid让执行命令时拥有属主的权限。风险很高，</li>
</ol>
<p>我们返回<strong>~/.ssh</strong>发现多了一个文件<strong>~/.ssh/known_hosts</strong>密钥文件这里面便记录着连接的主机，如果把里面的内容删除后，再次连接服务器便会提示输入密码。</p>
<p>这里补充一点小知识，我们现在已经知道了怎么去连接了，但是如果默认端口被改了后怎么能知道sshd服务的端口号是多少呢可以用下面命令来查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@backup ~]<span class="comment"># netstat -lntup|grep sshd</span></span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">52113</span>               <span class="number">0.0</span>.<span class="number">0.0</span>:*                   LISTEN      <span class="number">29649</span>/sshd          </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> :::<span class="number">52113</span>                    :::*                        LISTEN      <span class="number">29649</span>/sshd</span><br></pre></td></tr></table></figure>
<p>可以看到这里的端口号是52113。如果我知道端口号怎么来查看对应的服务呢？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ lsof -i :<span class="number">52113</span></span><br><span class="line">COMMAND   PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">sshd    <span class="number">29649</span> root    <span class="number">3</span>u  IPv4  <span class="number">51691</span>      <span class="number">0</span>t0  TCP *:<span class="number">52113</span> (LISTEN)</span><br><span class="line">sshd    <span class="number">29649</span> root    <span class="number">4</span>u  IPv6  <span class="number">51693</span>      <span class="number">0</span>t0  TCP *:<span class="number">52113</span> (LISTEN)</span><br></pre></td></tr></table></figure>
<h3 id="错误与优化">错误与优化</h3><p>报错字符串对应的可能问题：</p>
<ol>
<li>no route to host可能为防火墙</li>
<li>Connection refused可能为防火墙：Connection refused还可能是连接的对端服务没开<br>ssh -p 22 sandow@10.0.0.19 /sbin/ifconfig</li>
</ol>
<p>优化</p>
<ol>
<li>用密钥登录，不用密码登陆。</li>
<li>防火墙封闭ssh指定源限制</li>
<li>开启ssh只监听本地内网IP</li>
</ol>
<h2 id="scp">scp</h2><p>scp是一个远程的加密复制命令，用ssh加密传输，这个命令是全量copy，也有两种模式push， pull。 </p>
<p>参数：</p>
<ul>
<li>-1 , ssh1, </li>
<li>-2, ssh2</li>
<li>-4, ipv4</li>
<li>-6, ipv6</li>
<li>-l limit , 限定宽带大小，基本单位为kbit/s</li>
<li>-C, 使用压缩</li>
<li>-P， 指定端口</li>
<li>-p, 保留文件的最后修改时间，最后访问时间，权限模式</li>
<li>-r, recurisively copy</li>
</ul>
<p>远程推送：`scp -P52113 -rp /etc/hosts 172.16.1.41:~<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[sandow@NFS01 .ssh]$ scp -P52113 -rp /etc/hosts <span class="number">172.16</span>.<span class="number">1.41</span>:~</span><br><span class="line">hosts                                                                                <span class="number">100</span>%  <span class="number">211</span>     <span class="number">0.2</span>KB/s   <span class="number">00</span>:<span class="number">00</span></span><br></pre></td></tr></table></figure></p>
<p>远程拉取： 把两个文件换个位置这里就不讲了</p>
<h2 id="批量分发">批量分发</h2><p>OK，接下来就可以写个shell来批量分发指定文件到指定目录啦。这里我在家目录下创建一个send.sh. 内容如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="shebang">#!/bin/sh</span></span><br><span class="line">. /etc/init.d/<span class="built_in">functions</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> <span class="operator">-lt</span> <span class="number">1</span> ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"USAGE:/BIN/SH <span class="variable">$0</span> FILENAME"</span></span><br><span class="line">        <span class="built_in">exit</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> <span class="number">41</span> <span class="number">8</span> <span class="number">9</span> <span class="number">10</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        scp -P52113 -rp <span class="variable">$1</span>  <span class="number">172.16</span>.<span class="number">1</span>.<span class="variable">$&#123;n&#125;</span>:<span class="variable">$2</span> &amp;&gt;/dev/null</span><br><span class="line"><span class="keyword">if</span> [ $? <span class="operator">-eq</span> <span class="number">0</span> ];<span class="keyword">then</span></span><br><span class="line">        action <span class="string">"dis  <span class="variable">$1</span> to 172.16.1.<span class="variable">$&#123;n&#125;</span>:<span class="variable">$2</span>"</span> /bin/<span class="literal">true</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        action <span class="string">"dis  <span class="variable">$1</span> to 172.16.1.<span class="variable">$&#123;n&#125;</span>:<span class="variable">$2</span>"</span> /bin/<span class="literal">false</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>然后咱们来执行一下看看效果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[sandow@NFS01 ~]$ sh send.sh /etc/hosts ~</span><br><span class="line">dis  /etc/hosts to <span class="number">172.16</span>.<span class="number">1.41</span>:/home/sandow                [  OK  ]</span><br><span class="line">dis  /etc/hosts to <span class="number">172.16</span>.<span class="number">1.8</span>:/home/sandow                 [  OK  ]</span><br><span class="line">dis  /etc/hosts to <span class="number">172.16</span>.<span class="number">1.9</span>:/home/sandow                 [FAILED]</span><br><span class="line">dis  /etc/hosts to <span class="number">172.16</span>.<span class="number">1.10</span>:/home/sandow                [FAILED]</span><br></pre></td></tr></table></figure>
<p>OK，如果是windows下的话可以安装<strong>lrzsz</strong>来实现与linux下的文件互传。下面是一些总结<br>windows客户端和linux服务器之间传输数据工具：<br>1）rz、sz（lrzsz）。&lt;==讲过的。<br>2）winscp WinSCP-v4.0.5 &lt;==基于SSH,sftp<br>3）SFX(xshell)<br>4）SFTP   &lt;==基于SSH,加密传输<br>5)samba,http,ftp,nfs<br>FTP工具：vsftp, proftpd,SFTP</p>
<p>还有一些批量分发工具，改天我会介绍<strong>saltstack</strong> 与<strong>ansible</strong>. 其中<strong>stltstack</strong>是比较好用的高效的分发工具，有兴趣的同学可以先百度研究</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/vim/" itemprop="url">
                  vim常用操作
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2015-11-15T20:55:53+08:00" content="2015-11-15">
              2015-11-15
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分類於
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/vim/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="vim/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p>本文指在对VIM做简单的介绍，当你习惯之后，就会发现VIM是一个非常高效的文本编辑器而且不需要鼠標就可以完成任何操作，现在就让我们来见识VIM的强大</p>
<h1 id="VIM语法总结">VIM语法总结</h1><p><strong>命令模式下的编辑</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">语法</th>
<th style="text-align:left">描述</th>
<th style="text-align:center">语法</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">：wq!</td>
<td style="text-align:left">强制保存</td>
<td style="text-align:center">：q!</td>
<td style="text-align:left">强制退出不保存</td>
</tr>
<tr>
<td style="text-align:center">:set nu</td>
<td style="text-align:left">显示行号</td>
<td style="text-align:center">:set nonu</td>
<td style="text-align:left">取消显示行号</td>
</tr>
<tr>
<td style="text-align:center">u</td>
<td style="text-align:left">undo</td>
<td style="text-align:center">ctrl + r</td>
<td style="text-align:left">redo</td>
</tr>
<tr>
<td style="text-align:center">.</td>
<td style="text-align:left">重复前面命令</td>
<td style="text-align:center">2.</td>
<td style="text-align:left">重复前面命令2次</td>
</tr>
<tr>
<td style="text-align:center">dd</td>
<td style="text-align:left">向下删除一行</td>
<td style="text-align:center">2dd</td>
<td style="text-align:left">删除两行</td>
</tr>
<tr>
<td style="text-align:center">dt\</td>
<td style="text-align:left">删除行之后内容直到遇到“\”</td>
</tr>
<tr>
<td style="text-align:center">ye或 yw</td>
<td style="text-align:left">从当前位置拷贝到本单词的最后一个字符</td>
<td style="text-align:center">gu(gU)</td>
<td style="text-align:left">换成小写(大写)字母</td>
</tr>
</tbody>
</table>
<p><strong>如何移动</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">语法</th>
<th style="text-align:left">描述</th>
<th style="text-align:center">语法</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">w</td>
<td style="text-align:left">移动到单词开头</td>
<td style="text-align:center">e</td>
<td style="text-align:left">移动到单词结尾</td>
</tr>
<tr>
<td style="text-align:center">gg</td>
<td style="text-align:left">移动到的第一行</td>
<td style="text-align:center">G</td>
<td style="text-align:left">移动到最后一行</td>
</tr>
<tr>
<td style="text-align:center">0</td>
<td style="text-align:left">移动到行的开头</td>
<td style="text-align:center">$</td>
<td style="text-align:left">动到行的结尾</td>
</tr>
<tr>
<td style="text-align:center">^</td>
<td style="text-align:left">移动到行的开头非blank字符</td>
<td style="text-align:center">g_</td>
<td style="text-align:left">动到行的结尾非blank字符</td>
</tr>
<tr>
<td style="text-align:center">fa</td>
<td style="text-align:left">到下一个a出现的位置</td>
<td style="text-align:center">3fa</td>
<td style="text-align:left">第3次出现a的位置</td>
</tr>
<tr>
<td style="text-align:center">2g</td>
<td style="text-align:left">移动到第二行</td>
<td style="text-align:center">%</td>
<td style="text-align:left">匹配括号移动，包括 (, {, [. </td>
</tr>
<tr>
<td style="text-align:center">*</td>
<td style="text-align:left">匹配光标当前所在单词移到到下一个匹配到的单词</td>
<td style="text-align:center">#</td>
<td style="text-align:left">移动到上一个匹配到的单词</td>
</tr>
<tr>
<td style="text-align:center">/patten</td>
<td style="text-align:left">搜索，按n继续向下搜索</td>
<td style="text-align:center">N</td>
<td style="text-align:left">按N继续向上搜索</td>
</tr>
</tbody>
</table>
<p>ctrl + o 跳到上一次修改的地方</p>
<p><img src="/images/word_moves.jpg" alt="word_moves"><img src="/images/line_moves.jpg" alt="line_moves"></p>
<p><strong>以什么样的形式进入插入模式</strong></p>
<table>
<thead>
<tr>
<th style="text-align:center">语法</th>
<th style="text-align:left">描述</th>
<th style="text-align:center"></th>
<th style="text-align:center">语法</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">A</td>
<td style="text-align:left">移动到行未并进入插入模式</td>
<td style="text-align:center"></td>
<td style="text-align:center">x</td>
<td style="text-align:left">删除光标所在位置的字符</td>
</tr>
<tr>
<td style="text-align:center">I</td>
<td style="text-align:left">移到到行首并进入插入模式</td>
<td style="text-align:center"></td>
<td style="text-align:center">X</td>
<td style="text-align:left">删除光标所在位置之前的字符</td>
</tr>
<tr>
<td style="text-align:center">o</td>
<td style="text-align:left">在当前行之后新建一行并进入插入模式</td>
</tr>
</tbody>
</table>
<p><strong>区域选择</strong></p>
<p>其格式为 <code>&lt;action&gt;a&lt;object&gt;</code> 和 <code>&lt;action&gt;i&lt;object&gt;</code></p>
<ul>
<li>action可以是任何的命令，如 d (删除), y (拷贝), v (可以视模式选择)。</li>
<li>object 可能是： w 一个单词， W 一个以空格为分隔的单词， s 一个句字， p 一个段落。也可以是一个特别的字符：”、 ‘、 )、 }、 ]。</li>
</ul>
<p>举例： <code>daw</code> 删除一个单词</p>
<p><strong>块操作</strong></p>
<p>命令模式下按 <strong>ctrl + v</strong> 移动光标选中需要修改的行（区域），<br>然后按<strong>x</strong> 或者 <strong>d</strong> 删除该内容</p>
<p>批量在行首增加内容：<br> <code>ctrl + v</code> &gt;&gt; <code>0</code> &gt;&gt; <code>I</code> &gt;&gt; 写下想增加的内容 &gt;&gt;<code>Esc</code></p>
<p><img src="/images/rectangular-blocks.gif" alt="rectangular-blocks"></p>
<p>批量在行尾增加内容：</p>
<p> <code>ctrl + v</code> &gt;&gt; <code>$</code> &gt;&gt; <code>A</code> &gt;&gt; 写下想增加的内容 &gt;&gt;<code>Esc</code></p>
<p>块移动  <code>&lt;</code> , <code>&gt;</code> 左右缩进 。 <code>=</code> 自动给缩进。 </p>
<p><strong>自动补全</strong></p>
<p>vim 下在编辑模式下也有自动补全功能便不是tab键，而是 <code>ctrl + n</code>， <code>ctrl + p</code> 如果匹配到多个可以按多次来找到自己想要的单词</p>
<p><strong>宏录制</strong></p>
<p><code>qa</code>  开始录制宏，并把宏的名字取名为a<br><code>q</code>  停止录制宏<br><code>@a</code>  用@来调用宏并执行<br><code>@@</code>  快捷的执行最新操作的宏</p>
<p><img src="/images/macros.gif" alt="macros"></p>
<p><code>qa</code>  &gt;&gt;<code>Y</code> &gt;&gt; <code>p</code> &gt;&gt; <code>ctrl + a</code> &gt;&gt; <code>q</code> &gt;&gt; <code>@a</code> &gt;&gt; <code>100@@</code></p>
<p>最后来一张图，基本的语法就完全OK了</p>
<p><img src="/images/Vim-mindmap.png" alt="vim-midmap"></p>
<p><strong>结语</strong>：不论什么命令都可以在前面加数字来表示重复n次该命令</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/inotify_rsync/" itemprop="url">
                  rsync + inotify 实现实时同步
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2015-11-14T21:17:53+08:00" content="2015-11-14">
              2015-11-14
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分類於
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/inotify_rsync/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="inotify_rsync/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <h1 id="主机规划">主机规划</h1><table>
<thead>
<tr>
<th style="text-align:left">服务器</th>
<th style="text-align:left">外网IP</th>
<th style="text-align:left"></th>
<th style="text-align:left">内网IP</th>
<th style="text-align:left">主机名称</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">A1-nginx 负载服务器</td>
<td style="text-align:left">10.0.0.5/24</td>
<td style="text-align:left"></td>
<td style="text-align:left">127.16.1.5/24</td>
<td style="text-align:left">lb01</td>
</tr>
<tr>
<td style="text-align:left">A2-nginx 负载服务器</td>
<td style="text-align:left">10.0.0.6/24</td>
<td style="text-align:left"></td>
<td style="text-align:left">127.16.1.6/24</td>
<td style="text-align:left">lb02</td>
</tr>
<tr>
<td style="text-align:left">B1-apache软件web服务器</td>
<td style="text-align:left">10.0.0.7/24</td>
<td style="text-align:left"></td>
<td style="text-align:left">127.16.1.7/24</td>
<td style="text-align:left">web02</td>
</tr>
<tr>
<td style="text-align:left">B2-apache软件web服务器</td>
<td style="text-align:left">10.0.0.8/24</td>
<td style="text-align:left"></td>
<td style="text-align:left">127.16.1.8/24</td>
<td style="text-align:left">web01</td>
</tr>
<tr>
<td style="text-align:left">C3-My Sql 数据库服务器</td>
<td style="text-align:left"><code>10.0.0.51/24</code></td>
<td style="text-align:left"></td>
<td style="text-align:left">127.16.1.51/24</td>
<td style="text-align:left">Db01</td>
</tr>
<tr>
<td style="text-align:left">C1-NFS 存储服务器</td>
<td style="text-align:left"><code>10.0.0.31/24</code></td>
<td style="text-align:left"></td>
<td style="text-align:left">127.16.1.31/24</td>
<td style="text-align:left">NFS01</td>
</tr>
<tr>
<td style="text-align:left">C2-rsync 数据库服务器</td>
<td style="text-align:left"><code>10.0.0.41/24</code></td>
<td style="text-align:left"></td>
<td style="text-align:left">127.16.1.41/24</td>
<td style="text-align:left">Backup</td>
</tr>
<tr>
<td style="text-align:left">X-管理服务器</td>
<td style="text-align:left"><code>10.0.0.61/24</code></td>
<td style="text-align:left"></td>
<td style="text-align:left">127.16.1.61/24</td>
<td style="text-align:left">m01</td>
</tr>
</tbody>
</table>
<blockquote>
<p>红色仅为虚拟机中测试所用 <br><br>机房根据实际需求配置</p>
</blockquote>
<h2 id="克隆虚拟机并配置网卡">克隆虚拟机并配置网卡</h2><ol>
<li>编辑eth0的配置文件：<code>vi /etc/sysconfig/network-scripts/ifcfg-eth0</code>，删除HWADDR地址那一行及UUID的行如下：</li>
</ol>
<pre><code>HWADDR=<span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:<span class="number">08</span>:<span class="number">28</span>:<span class="number">9f</span>     
UUID=cee39dbb-<span class="number">6</span>a10-<span class="number">4425</span>-<span class="number">9</span>daf-<span class="number">768</span>b6e79a9c9
</code></pre><ol>
<li>清空 /etc/udev/rules.d/70-persistent-net.rules</li>
<li>重启</li>
</ol>
<h2 id="RSYNC_数据库服务器">RSYNC 数据库服务器</h2><p>rsync, (remote synchronize) 是一个实现同步功能的软件，它在同步文件的同时，可以保持原来文件的权限，时间，软硬链接等附加信息。 rsync是用rsync 算法提供了一个客户机和远程文件服务器的文件同步的快速方法，而且可以通过ssh方式来传输文件，这样保密也非常好。主要用于远程数据备份与同步。 可以实现全备及增量备份，也可以本地数据同步。 在Centos5中rsync的版本是2.X，是把所有文件比对一遍后进行同步。在CentOs6中rsync的版本是3.0，是一边比对差异一边进行同步。而这里我们用的是3.0</p>
<p>首先检查rsync看是否安装，及安装的版本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ rpm -qa rsync</span><br><span class="line">rsync-<span class="number">3.0</span><span class="number">.6</span>-<span class="number">12.</span>el6.x86_64</span><br></pre></td></tr></table></figure>
<p>rsync有三种模式，分别是本地，ssh远程同步，daemon模式</p>
<ul>
<li><p>Local:  <code>rsync [OPTION...] SRC... [DEST]</code></p>
</li>
<li><p>Access via remote shell:</p>
<ul>
<li>Pull: <code>rsync [OPTION...] [USER@]HOST:SRC... [DEST]</code></li>
<li>Push: <code>rsync [OPTION...] SRC... [USER@]HOST:DEST</code></li>
</ul>
</li>
<li><p>Access via rsync daemon:</p>
<ul>
<li>Pull: <code>rsync [OPTION...] [USER@]HOST::SRC... [DEST]</code>    <pre><code>`rsync <span class="string">[OPTION...]</span> rsync://<span class="string">[USER@]</span>HOST<span class="string">[:PORT]</span>/SRC... <span class="string">[DEST]</span>`
</code></pre></li>
<li>Push: <code>rsync [OPTION...] SRC... [USER@]HOST::DEST</code>    <pre><code>`rsync <span class="string">[OPTION...]</span> SRC... rsync://<span class="string">[USER@]</span>HOST<span class="string">[:PORT]</span>/DEST`
</code></pre></li>
</ul>
</li>
</ul>
<p>都是把SRC的数据同步到DEST. 如果没有DEST，但会把SRC的文件列出来而不copy</p>
<p>rsync 参数说明：</p>
<ul>
<li>–delete;     delete extraneous files from dest dirs 删除目标文件中多余的文件</li>
<li>–exclude=PATTERN ;      exclude files matching PATTERN 排除特定文件 –exclude={a,b}</li>
<li>–exclude-from=FILE;     read exclude patterns from FILE  ,–exclude-from=/tmp/exclude.txt</li>
<li>-z, –compress    ;          compress file data during the transfer</li>
<li>-v, –verbose               increase verbosity</li>
<li>-a, –archive               archive mode; equals -rlptgoD (no -H,-A,-X)</li>
<li>–bwlimit=KBPS          limit I/O bandwidth; KBytes per second </li>
<li>–partial               keep partially transferred files 断点续传</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#排除单个文件：</span></span><br><span class="line">$ rsync -auvrtzopgP --progress --exclude=a /backup/ rsync_backup@<span class="number">172.16</span><span class="number">.1</span><span class="number">.41</span>::backup --password-file=/etc/rsync.password</span><br><span class="line"></span><br><span class="line"><span class="comment">#排除多个文件：</span></span><br><span class="line">$ rsync -avz --exclude=&#123;a,b&#125; /backup/ rsync_backup@<span class="number">172.16</span><span class="number">.1</span><span class="number">.41</span>::backup --password-file=/etc/rsync.password</span><br><span class="line"></span><br><span class="line">$ rsync -avz --exclude-<span class="keyword">from</span>=paichu.log /backup/ rsync_backup@<span class="number">172.16</span><span class="number">.1</span><span class="number">.41</span>::backup --password-file=/etc/rsync.password</span><br></pre></td></tr></table></figure>
<h3 id="本地备份">本地备份</h3><p>本地 模式，相当于copy 或者rm<br>比如<code>$ rsync -auvrtzopgP /tmp/ /backup/</code> <br><br>此命令就会把tmp目录下的文件全部复制到backup目录下面， 如果加上<code>--delete</code>，此参数的意思是把目标目录与源目录同步，当目标目录里有多于源目录的文件就会删除，也就是源目录是啥样，目标目录就是啥样。如果源目录为空，目标目录也会被清空。我们一般都会在目录后面加<code>/</code>意思是目录下面，如果不加就直接把目录复制过去了，在远程的时候也是一样的。<br><br>保持属性： -avz  相当于 cp -rp<br><br><br></p>
<h3 id="通过shell远程传输(remote)">通过shell远程传输(remote)</h3><p>远程拷贝；相当于ssh带的scp命令，但又优于scp命令的功能。scp每次都是全量拷贝。rsync可以增量拷贝。 当源路径，或目的路径后面包含一个卡号</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ rsync -avz -e 'ssh -p 22' root@172.16.1.41:/tmp/ /tmp/</span><br><span class="line">The authenticity of host '172.16.1.41 (172.16.1.41)' can't be established.</span><br><span class="line">RSA key fingerprint is 97:b9:1f:95:8b:7d:ae:59:27:4a:d4:b3:98:ae:c1:77.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added '172.16.1.41' (RSA) to the list of known hosts.</span><br><span class="line">root@172.16.1.41's password: </span><br><span class="line">receiving incremental file list</span><br><span class="line">created directory /temp</span><br><span class="line">./</span><br><span class="line">hosts</span><br><span class="line">.ICE-unix/</span><br><span class="line"></span><br><span class="line">sent 37 bytes  received 184 bytes  9.02 bytes/sec</span><br><span class="line">total size is 220  speedup is 1.00</span><br></pre></td></tr></table></figure>
<p><br><br>此命令便是把ip为172.16.1.41的主机里tmp目录下的文件传到本地的/tmp/下。这里 <code>ssh -p 22</code>命令用于指定端口，默认就是22，-e 这个参数可以不写直接 <code>rsync -avz root@172.16.1.41:/tmp/ /tmp/</code>便可以把41的文件复制过来。且这里是交互式，手动备份与推送，十分不方便。</p>
<p>这里有个问题，如果我们用其它用户推或者拉，的时候需要共享文件的所属主与所属组都对该用户对应</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@NFS</span> tmp]<span class="variable">$ </span>rsync -avz /data/ sandow<span class="variable">@172</span>.<span class="number">16.1</span>.<span class="number">41</span><span class="symbol">:/data/</span></span><br></pre></td></tr></table></figure>
<p>此命令是把本地data目录下的文件推到服务器IP为：41下的data目录下。这里两个data目录都要具有对应主机用户的读取执行写入权限，最好的办法就是把该目录的所属主，所属组改为对应的用户</p>
<h3 id="daemon_模式，">daemon 模式，</h3><p>daemon模式需要配置文件，使用<code>rsync --daemon</code>启动进程，使用独立的进程方式传输文件，默认端口是873。</p>
<p>这里需要两台服务器做测试环境，服务器端名为backup, ip为172.16.1.41主要用于存放数据. 客户端(NFS01)IP为172.16.1.31 主要用于向服务器推送（备份）拉回（还原）数据。然后结合crontab实现实时自动备份同步。 </p>
<h4 id="服务端的配置">服务端的配置</h4><p>首先我们来配置rsync的主配置文件 rsyncd.conf，默认情况下该文件不存在需要创建，我们也可以使用<code>man rsyncd.conf</code>来查看主配置文件里的参数与说明。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@backup ~]$ cat /etc/rsyncd.conf</span><br><span class="line"><span class="comment">#Rsync server</span></span><br><span class="line"><span class="comment">#created by sandow at 2015-11-05</span></span><br><span class="line"><span class="comment">#rsyncd.conf start#</span></span><br><span class="line">uid = rsync		//相当于nfsnobody 客户端连过来具备什么样的权限默认是不存在的</span><br><span class="line">gid = rsync		//相当于nfsnobody</span><br><span class="line">use chroot = no		//   程序出现问题就会开启 开启给个空目录就行</span><br><span class="line">max connections = <span class="number">200</span>		//客户端连接数 可以同时</span><br><span class="line">timeout = <span class="number">300</span>        //超时 这是服务端 客户端连过来最多多久后就断掉</span><br><span class="line">strict modes=yes</span><br><span class="line">port=<span class="number">873</span></span><br><span class="line">pid file = /var/run/rstbcd.pid	//PID就是进程号唯一标识进程,进程号放文件里面</span><br><span class="line">lock file = /var/run/rsync.lock		//锁文件</span><br><span class="line">log file = /var/log/rsyncd.log		//日志文件，出问题在这里看</span><br><span class="line">hosts allow = <span class="number">172.16</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span>		//允许ip</span><br><span class="line">hosts deny = <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">32</span>		//拒绝</span><br><span class="line">secrets file = /etc/rsync.password		//存放用户和密码文件</span><br><span class="line"></span><br><span class="line">[backup]		//模块，调用下面服务</span><br><span class="line">comment=backup server by liuchunhao at <span class="number">2015</span>-<span class="number">11</span>-<span class="number">05</span>		//注释</span><br><span class="line">path = /backup		//共享目录</span><br><span class="line">read only = false		//可读写</span><br><span class="line">ignore errors		//忽略错误</span><br><span class="line">auth users = rsync_backup		//远程连接的用户，虚拟用户和系统用户没关系</span><br><span class="line">uid=rsync_backup</span><br><span class="line">gid=rsync_backup</span><br><span class="line">list = false		//不让远程列表，不让看服务端有什么</span><br><span class="line">secrets file=/etc/rsync.password</span><br></pre></td></tr></table></figure>
<p>配置好rsyncd.conf后便接下来就可以创建对应用户、目录与密码文件</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@backup</span> ~]<span class="variable">$ </span>useradd rsync -s /sbin/nologin -<span class="constant">M</span></span><br><span class="line">[root<span class="variable">@backup</span> ~]<span class="variable">$ </span>id rsync</span><br><span class="line">uid=<span class="number">504</span>(rsync) gid=<span class="number">504</span>(rsync) groups=<span class="number">504</span>(rsync)</span><br><span class="line">[root<span class="variable">@backup</span> ~]<span class="variable">$ </span>mkdir -p /backup</span><br><span class="line">[root<span class="variable">@backup</span> ~]<span class="variable">$ </span>chown -<span class="constant">R</span> rsync.rsync /backup/</span><br><span class="line">[root<span class="variable">@backup</span> ~]<span class="variable">$ </span>ls -ld /backup/              </span><br><span class="line">drwxr-xr-t. <span class="number">3</span> rsync rsync <span class="number">4096</span> <span class="constant">Nov</span> <span class="number">12</span> <span class="number">06</span><span class="symbol">:</span><span class="number">53</span> /backup/</span><br></pre></td></tr></table></figure>
<p>创建密码文件，并且修改属性为600</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@backup</span> ~]<span class="variable">$ </span>echo <span class="string">"rsync_backup:oldboy"</span> &gt;<span class="regexp">/etc/rsync</span>.password</span><br><span class="line">[root<span class="variable">@backup</span> ~]<span class="variable">$ </span>cat /etc/rsync.password</span><br><span class="line"><span class="symbol">rsync_backup:</span>oldboy</span><br><span class="line">[root<span class="variable">@backup</span> ~]<span class="variable">$ </span>chmod <span class="number">600</span> /etc/rsync.password</span><br><span class="line">[sandow<span class="variable">@backup</span> ~]<span class="variable">$ </span>ll /etc/rsync.password       </span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">20</span> <span class="number">11</span>月  <span class="number">6</span> <span class="number">16</span><span class="symbol">:</span><span class="number">12</span> /etc/rsync.password</span><br></pre></td></tr></table></figure>
<p>修改/etc/xinetd.d/rsync 文件，把disable 改为no,这应该是最新版本的linux才会有此文件。所以没有的可以不配置</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># default: off</span><br><span class="line"># description: The rsync server is a good addition to an ftp server, as it \</span><br><span class="line">#	allows crc checksumming etc.</span><br><span class="line">service rsync</span><br><span class="line">&#123;</span><br><span class="line">	disable	= no</span><br><span class="line">	flags		= IPv6</span><br><span class="line">	socket_type     = stream</span><br><span class="line">	wait            = no</span><br><span class="line">	user            = root</span><br><span class="line">	server          = /usr/bin/rsync</span><br><span class="line">	server_args     = --daemon</span><br><span class="line">	log_on_failure  += USERID</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置好后便可以启动rsync daemon守护进程了</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[sandow<span class="variable">@backup</span> tmp]<span class="variable">$ </span>rsync --daemon</span><br><span class="line"></span><br><span class="line">[sandow<span class="variable">@backup</span> tmp]<span class="variable">$ </span>ps -ef|grep rsync |grep -v grep</span><br><span class="line">root       <span class="number">2370</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">01</span><span class="symbol">:</span><span class="number">57</span> ?        <span class="number">00</span><span class="symbol">:</span><span class="number">00</span><span class="symbol">:</span><span class="number">00</span> rsync --daemon</span><br><span class="line"></span><br><span class="line">[sandow<span class="variable">@backup</span> tmp]<span class="variable">$ </span>netstat -lntup|grep rsync</span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span><span class="symbol">:</span><span class="number">873</span>                 <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span><span class="symbol">:*</span>                   <span class="constant">LISTEN</span>      <span class="number">2370</span>/rsync          </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="symbol">:</span><span class="symbol">:</span><span class="symbol">:</span><span class="number">873</span>                      <span class="symbol">:</span><span class="symbol">:</span><span class="symbol">:*</span>                        <span class="constant">LISTEN</span>      <span class="number">2370</span>/rsync</span><br></pre></td></tr></table></figure>
<p>然后让rsync开机自动启动：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="string">"/usr/bin/rsync --daemon"</span> <span class="prompt">&gt;&gt;</span>/etc/rc.local</span><br></pre></td></tr></table></figure>
<p>这里需要注意的是要让端口873通过防火墙</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -m state --state <span class="constant">NEW</span>  -m tcp --dport <span class="number">873</span> -j <span class="constant">ACCEPT</span></span><br><span class="line"><span class="variable">$ </span>iptables -<span class="constant">L</span>  查看一下防火墙是不是打开了 <span class="number">873</span>端口</span><br></pre></td></tr></table></figure>
<h4 id="客户端的配置">客户端的配置</h4><p>客户端的配置很简单，仅需要增加一个密码文件并把权限改为600</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@NFS</span> tmp]<span class="variable">$ </span>echo <span class="string">"oldboy"</span> &gt;<span class="regexp">/etc/rsync</span>.password</span><br><span class="line">[root<span class="variable">@NFS</span> tmp]<span class="variable">$ </span>chmod <span class="number">600</span> /etc/rsync.password </span><br><span class="line">[root<span class="variable">@NFS</span> tmp]<span class="variable">$ </span>ll /etc/rsync.password </span><br><span class="line">-rw-------. <span class="number">1</span> root root <span class="number">7</span> <span class="constant">Nov</span> <span class="number">12</span> <span class="number">02</span><span class="symbol">:</span><span class="number">03</span> /etc/rsync.password</span><br><span class="line">[root<span class="variable">@NFS</span> tmp]<span class="variable">$ </span>cat /etc/rsync.password </span><br><span class="line">oldboy</span><br></pre></td></tr></table></figure>
<h4 id="备份数据以及自动备份">备份数据以及自动备份</h4><p>向服务器推送数据：</p>
<p><code>rsync -auvrtzopgP --progress  /backup/ rsync_backup@172.16.1.41::backup --password-file=/etc/rsync.password</code></p>
<p>或者</p>
<p><code>rsync -auvrtzopgP --progress  /backup/ rsync://rsync_backup@172.16.1.41/backup --password-file=/etc/rsync.password</code></p>
<p>从服务器拉回数据</p>
<p><code>rsync -avz   rsync_backup@172.16.1.41::backup /backup/ --password-file=/etc/rsync.password</code></p>
<p>或者</p>
<p><code>rsync -avz   rsync://rsync_backup@172.16.1.41/backup  /backup/ --password-file=/etc/rsync.password</code></p>
<h3 id="小结">小结</h3><p>配置步骤回顾</p>
<blockquote>
<p>查看rsync 安装包&gt;&gt;  添加rsync用户 &gt;&gt;  生成配置文件 &gt;&gt;   配置账户，密码文件 &gt;&gt;  密码文件配置权限 600  &gt;&gt;  创建共享的目录并授权rsync &gt;&gt;启动rsync  <code>rsync --daemon</code> &gt;&gt; 开机启动<br>排错小结：查看推送或者拉取报错信息， 查看日志 <code>tail /var/log/rsyncd.log</code></p>
</blockquote>
<p>重启rsync就必须杀掉进程</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@backup</span> backup]<span class="variable">$ </span>kill <span class="string">`cat /var/run/rsyncd.pid`</span></span><br><span class="line">[root<span class="variable">@backup</span> backup]<span class="variable">$ </span>lsof -i <span class="symbol">:</span><span class="number">873</span></span><br><span class="line">[root<span class="variable">@backup</span> backup]<span class="variable">$ </span>pkill rsync</span><br><span class="line">[root<span class="variable">@backup</span> backup]<span class="variable">$ </span>killall rsync</span><br></pre></td></tr></table></figure>
<p>rsync 优点</p>
<ol>
<li>增量备份， 支持socket 集中备份，（支持推拉，都是以客户端参照物）</li>
<li>远程shell 通道模式还可以加密(ssh) 传输 。 socket 需要加密传输，可以利用vpn 服务或ipsec服务</li>
</ol>
<p>rsync 缺点</p>
<ol>
<li>大量小文件时候同步的时候，比对时间长，有的时候，rsync进程可能会停止</li>
<li>同步大文件，10G 这样的大文件有时也会问题，中断。 未完整同步前，是隐藏文件</li>
</ol>
<p>实战作业：<br>5.1.4.2 备份全网服务器数据生产架构方案案例模型<br>企业案例：rsync上机实战考试题：<br>某公司里有一台Web服务器，里面的数据很重要，但是如果硬盘坏了，数据就会丢失，现在领导要求你把数据在其他机器上做一个周期性定时备份。要求如下：<br>每天晚上00点整在Web服务器A上打包备份网站程序目录并通过rsync命令推送到服务器B上备份保留（备份思路可以是先在本地按日期打包，然后再推到备份服务器上）。<br>具体要求如下：<br>1)Web服务器A和备份服务器B的备份目录必须都为/backup。<br>2)Web服务器站点目录假定为(/var/www/html)。<br>3)Web服务器本地仅保留7天内的备份。<br>4)备份服务器上检查备份结果是否正常，并将每天的备份结果发给管理员信箱（选做）。<br>5)备份服务器上每周六的数据都保留，其他备份仅保留180天备份（选做）。</p>
<p>拔锚必备思想：<br>部署流程步骤熟练<br>rsync原理理解</p>
<h2 id="crontab_+_rsync_定时推送">crontab + rsync 定时推送</h2><p>定时任务一般都新建一个目录专门用来存放定时任务的sh.我一般呢会存放在<strong>/server/scripts/</strong>目录下面。 新建一个sh 命名为rsync.dailyBackup.sh. 增加好下内容</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ cat rsync.dailyBackup.sh</span><br><span class="line">#! /bin/sh</span><br><span class="line"># backup /backup  to 172.16.1.41:/backup</span><br><span class="line">path=/backup</span><br><span class="line">hostn=$(hostname)</span><br><span class="line">dir=$&#123;hostn&#125;-172.16.1.31</span><br><span class="line">ldate=$(date +%F)</span><br><span class="line">mkdir  $&#123;path&#125;/$&#123;dir&#125; &amp;&amp;\</span><br><span class="line">/bin/cp /etc/rc.local $&#123;path&#125;/$&#123;dir&#125;/rc.local_$&#123;ldate&#125; &amp;&amp;\</span><br><span class="line">rsync -az $&#123;path&#125;/ rsync_backup@172.16.1.41::backup/ --password-file=/etc/rsync.password</span><br></pre></td></tr></table></figure>
<p>首先测试是否成功执行任务，并推送到rsync服务器。然后便写入crontab </p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>crontab -l</span><br><span class="line"><span class="comment">#######time sync by lzy at 2015-11-02</span></span><br><span class="line">*<span class="regexp">/5 * * * * /usr</span><span class="regexp">/sbin/ntpdate</span> time.nist.gov &gt;<span class="regexp">/dev/null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">####rsync by lzy at 2015-11-07</span></span><br><span class="line"><span class="number">00</span> <span class="number">01</span> * * * <span class="regexp">/bin/sh</span> /server/scripts/rsync.sh &gt;<span class="regexp">/dev/null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br></pre></td></tr></table></figure>
<h2 id="实时同步">实时同步</h2><p>inotify+rsync<br>inotify 是一种强大的细粒度的，异步的文件系统事件监控机制， linux内核从2.6.13起，加入了inotify支持。其本身没有推送的功能，只 有监控文件系统的任务. 我们可以用inotify + rsync 做到实时复制，但是<br>sersync 国人周洋编辑的<br>inotify + rsync 实时复制  osersync<br>每秒只能同步200张100K的图片  可以用drbd （备节点不可用）  双协</p>
<p>查看系统是否支持inotify，如果没有下列文件便表示不支持</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>ll /proc/sys/fs/inotify/</span><br><span class="line">total <span class="number">0</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> <span class="constant">Nov</span>  <span class="number">9</span> <span class="number">17</span><span class="symbol">:</span><span class="number">39</span> max_queued_events</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> <span class="constant">Nov</span>  <span class="number">9</span> <span class="number">17</span><span class="symbol">:</span><span class="number">39</span> max_user_instances</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> <span class="constant">Nov</span>  <span class="number">9</span> <span class="number">17</span><span class="symbol">:</span><span class="number">39</span> max_user_watches</span><br></pre></td></tr></table></figure>
<ul>
<li>max_queued_events,表示调用inotify_init时分配给inotify instance中可排队的event的数目的最大值，超出这值的事件被丢弃，触发IN_Q_OVERFLOW事件</li>
<li>max_user_instances 每一个user ID可创建的inotify instatnces的数量上限</li>
<li>max_user_watches表示每个inotify instatnces可监控的最大目录数量。</li>
</ul>
<p>安装inotify-tools<br>方法一</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="variable">$ </span>rpm -ivh /apps/crm/soft_src/inotify-tools-<span class="number">3.14</span>-<span class="number">1</span>.el6.x86_64.rpm </span><br><span class="line"><span class="symbol">warning:</span> /apps/crm/soft_src/inotify-tools-<span class="number">3.14</span>-<span class="number">1</span>.el6.x86_64.<span class="symbol">rpm:</span> <span class="constant">Header</span> <span class="constant">V3</span> <span class="constant">DSA</span>/<span class="constant">SHA1</span> <span class="constant">Signature</span>, key <span class="constant">ID</span> <span class="number">4026433</span><span class="symbol">f:</span> <span class="constant">NOKEY</span></span><br><span class="line"><span class="constant">Preparing</span>...                <span class="comment">########################################### [100%]</span></span><br><span class="line">   <span class="number">1</span><span class="symbol">:inotify-tools</span>          <span class="comment">########################################### [100%]</span></span><br><span class="line"><span class="variable">$ </span>rpm -qa|grep inotify</span><br><span class="line">inotify-tools-<span class="number">3.14</span>-<span class="number">1</span>.el5.x86_64</span><br></pre></td></tr></table></figure>
<p>方法二</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget http://github.com/downloads/rvoicilas/inotify-tools/inotify-tools-3.14.tar.gz</span><br><span class="line">tar zxvf inotify-tools-3.14.tar.gz</span><br><span class="line">cd inotify-tools-3.14</span><br><span class="line">./configure --prefix=/usr/local/inotify</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<h3 id="inotifywait_介绍">inotifywait 介绍</h3><p>如果文件或者目录变更，那么就会调用inotify命令。是一个非常高效的工具。<br>其语法格式是</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inotifywait [-hcmrq] [-e &lt;event&gt; ] [-t &lt;seconds&gt; ] [--format &lt;fmt&gt; ] [--timefmt &lt;fmt&gt; ] &lt;file&gt; [ ... ]</span><br></pre></td></tr></table></figure>
<p>参数：</p>
<ul>
<li>-m  监听</li>
<li>-r, –recursive 递归监控</li>
<li>-q, –quiet，不输出信息</li>
<li>–exclude <pattern\></pattern\></li>
<li>-e <event\>, –event <event\><ul>
<li>delete ,create,close_write,modify </li>
</ul>
</event\></event\></li>
<li>–timefmt <fmt> 设置一个时间样式</fmt></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">inotifywait -mrq --timefmt <span class="string">'%d/%m/%y %H:%M'</span> --format <span class="string">'%T %w %f'</span> -e create /backup  </span><br><span class="line">inotifywait -mrq --timefmt <span class="string">'%d/%m/%y %H:%M'</span> --format <span class="string">'%T %w %f'</span> -e create,delete,close_write /backup</span><br></pre></td></tr></table></figure>
<p>执行第二个命令后的结果格式结果是</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">47</span> /backup/ a</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">47</span> /backup/ a</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">47</span> /backup/ a.txt</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">47</span> /backup/ a.txt</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">47</span> /backup/ .test.txt.swp</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">47</span> /backup/ .test.txt.swx</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">47</span> /backup/ .test.txt.swx</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">47</span> /backup/ .test.txt.swx</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">47</span> /backup/ .test.txt.swp</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">47</span> /backup/ .test.txt.swp</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">47</span> /backup/ .test.txt.swp</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">48</span> /backup/ test.txt</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">48</span> /backup/ test.txt</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">48</span> /backup/ .test.txt.swp</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">48</span> /backup/ .test.txt.swp</span><br></pre></td></tr></table></figure>
<p>刚才注意到 创建一个文件产生的临时文件也都会被记录下来。而且还有重复。为了同步时减少带宽与CPU消耗，就需要使用排除，来排除指定的文件。排除一般有两种方法：1，使用rsync排除; 2,使用inotify排除，同时加入rsync排除,我们一般使用第二种<br>inotifywati排队监控目录有 –exclude <pattern\> –formfile <file\> 前面可以用正则，后者只能是具体的目录或文件</file\></pattern\></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi inotify_exclude.lst</span><br><span class="line">/tmp/src/pdf</span><br><span class="line">@/tmp/src/<span class="number">2014</span></span><br></pre></td></tr></table></figure>
<p>–formfile 的file只能使用绝对路径，@表示排除。<br>用正则排除 </p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--exclude <span class="string">'(.*/*\.log|.*/*\.swp)$|^/tmp/src/mail/(2014|201.*/cache.*)'</span></span><br></pre></td></tr></table></figure>
<p>正则很明子了吧。 排除所有目录下以<strong>.log</strong>, <strong>.swp</strong> 结尾的文件，和所有在/tmp/src/mail下面2014这个目录和201*目录下的cache开头的文件或目录<br>在rsync里排除，这里指定file排除时用相对路径。</p>
<p>写一个角本<strong>inotifywait.sh</strong>放到backup目录下面,执行便可以实时同步，以下是几个版本<br>粗糙版，每次都会让rsync比对所有文件然后再同步</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /bin/bash</span></span><br><span class="line">/usr/bin/inotifywait -mrq  --format <span class="string">'%w%f'</span> -e create,close_write,delete /backup | \</span><br><span class="line"><span class="keyword">while</span> read file</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  	cd /backup &amp;&amp; \</span><br><span class="line">  	rsync -az ./ --delete rsync_backup<span class="variable">@172</span>.<span class="number">16.1</span>.<span class="number">41</span><span class="symbol">:</span><span class="symbol">:backup</span> --password-file=<span class="regexp">/etc/rsync</span>.password</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>精准版</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /bin/sh</span></span><br><span class="line"><span class="constant">FullPath</span>=<span class="string">"/usr/bin/inotifywait"</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$&#123;</span><span class="constant">FullPath</span>&#125; -mrq --format <span class="string">'%w%f'</span> -e create,close_write,delete /backup | \</span><br><span class="line">	<span class="keyword">while</span> read <span class="constant">Line</span></span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">  	[ ! -e  <span class="string">"$line"</span> ]  &amp;&amp;\</span><br><span class="line">  rsync -az --delete ./ rsync_backup<span class="variable">@172</span>.<span class="number">16.1</span>.<span class="number">41</span><span class="symbol">:</span><span class="symbol">:backup</span> --password-file=<span class="regexp">/etc/rsync</span>.password &amp;&amp; \</span><br><span class="line">	continue</span><br><span class="line">  rsync -az --delete <span class="variable">$&#123;</span><span class="constant">Line</span>&#125; rsync_backup<span class="variable">@172</span>.<span class="number">16.1</span>.<span class="number">41</span><span class="symbol">:</span><span class="symbol">:backup</span> --password-file=<span class="regexp">/etc/rsync</span>.password</span><br><span class="line">	done</span><br></pre></td></tr></table></figure>
<p>上面的是不是很简单，那么再来一个更全面的客户端配置文件</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#rsync auto sync script with inotify</span><br><span class="line">#2015-11-09 sandow</span><br><span class="line">#variables</span><br><span class="line">Current_date=$(date +%Y%m%d_%H%M%S)</span><br><span class="line">source_path=/backup/</span><br><span class="line">log_file=/var/log/rsync_client.log</span><br><span class="line">#rsync</span><br><span class="line">rsync_server=172.16.1.41</span><br><span class="line">rsync_user=rsync_backup</span><br><span class="line">rsync_pwd=/etc/rsync.password</span><br><span class="line">rsync_module=backup</span><br><span class="line">INOTIFY_EXCLUDE="(.*/*\.log|.*/*\.swp)$|^/tmp/src/mail/(2014|20.*/.*che.*)"</span><br><span class="line">RSYNC_EXCLUDE=/etc/rsyncd.d/rsync_exclude.lst</span><br><span class="line">#rsync client pwd check</span><br><span class="line">if [ ! -e $&#123;rsync_pwd&#125; ];then</span><br><span class="line">    echo -e "rsync client passwod file $&#123;rsync_pwd&#125; does not exist!"</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line">#inotify_function</span><br><span class="line">inotify_fun()&#123;</span><br><span class="line">    /usr/bin/inotifywait -mrq --timefmt '%Y/%m/%d-%H:%M:%S' --format '%T %w %f' \</span><br><span class="line">          --exclude $&#123;INOTIFY_EXCLUDE&#125;  -e modify,delete,create,move,attrib $&#123;source_path&#125; | \</span><br><span class="line">      while read file</span><br><span class="line">      do</span><br><span class="line">          /usr/bin/rsync -auvrtzopgP --exclude-from=$&#123;RSYNC_EXCLUDE&#125; --progress --bwlimit=200 --password-file=$&#123;rsync_pwd&#125; $&#123;source_path&#125; $&#123;rsync_user&#125;@$&#123;rsync_server&#125;::$&#123;rsync_module&#125; </span><br><span class="line">      done</span><br><span class="line">&#125;</span><br><span class="line">#inotify log</span><br><span class="line">inotify_fun &gt;&gt; $&#123;log_file&#125; 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<p>来点链接，深入研究的话可以上去查看 <br></p>
<blockquote>
<p><a href="https://rsync.samba.org/how-rsync-works.html" target="_blank" rel="external">How Rsync Works A Practical Overview</a> <br><br><a href="https://www.ibm.com/developerworks/cn/linux/l-inotify/" target="_blank" rel="external">用 inotify 监控 Linux 文件系统事件</a> <br><br><a href="http://www.infoq.com/cn/articles/inotify-linux-file-system-event-monitoring" target="_blank" rel="external">inotify: 高效、实时的Linux文件系统事件监控框架</a> <br><br><a href="http://coolshell.cn/articles/7425.html" target="_blank" rel="external">rsync 的核心算法</a></p>
</blockquote>
<h2 id="sersync">sersync</h2><p>听同事说 sersync 这么个工具可以提高同步的性能，也解决了同步大文件时出现异常的问题，所以就尝试了一下。sersync是国内的一个开发者开源出来的，使用c++编写，采用多线程的方式进行同步，失败后还有重传机制，对临时文件过滤，自带crontab定时同步功能。网上看到有人说性能还不错，但是我觉得：</p>
<p>国产开源，文档不是很全，在2011年之后就没更新了。采用xml配置文件的方式，可读性比较好，但是有些原生的有些功能没有实现就没法使用了。</p>
<p>无法实现多目录同步，只能通过多个配置文件启动多个进程，文件排除功能太弱。</p>
<p>虽然提供插件的功能，但很鸡肋，因为软件本身没有持续更新，也没有看到贡献有其它插件出现（可能是我知识面不够，还用不到里面的refreshCDN plugin）。虽然不懂c++，但大致看了下源码 FileSynchronize，拼接rsync命令大概在273行左右，最后一个函数就是排除选项，简单一点可以将–exclude=改成–eclude-from来灵活控制。有机会再改吧。</p>
<p>另外，在作者的文章 Sersync服务器同步程序 项目简介与设计框架 评论中，说能解决上面 rsync + inotify中所描述的问题。阅读了下源码，这个应该是没有解决，因为在拼接rsync命令时，后面的目的地址始终是针对module的，只要执行rsync命令，就会对整个目录进行遍历，发送要比对的文件列表，然后再发送变化的文件。sersync只是减少了监听的事件，减少了rsync的次数——这已经是很大的改进，但每次rsync没办法改变。（如有其它看法可与我讨论）</p>
<p>其实我们也不能要求每一个软件功能都十分健全，关键是看能否满足我们当下的特定的需求。所谓好的架构不是设计出来的，而是进化来的。目前使用sersync2没什么问题，而且看了它的设计思路应该是比较科学的，特别是过滤队列的设计。双向同步看起来也是可以实现。</p>
<h2 id="rsync常见错误与问题">rsync常见错误与问题</h2><p>Q：如何通过ssh进行rsync，而且无须输入密码？    </p>
<ul>
<li><p>可以通过以下几个步骤        </p>
<ol>
<li>通过ssh-keygen在server A上建立SSH keys，不要指定密码，你会在~/.ssh下看到identity和identity.pub文件 </li>
<li>在server B上的home目录建立子目录.ssh</li>
<li>将A的identity.pub拷贝到server B上</li>
<li>将identity.pub加到~[user b]/.ssh/authorized_keys</li>
<li>于是server A上的A用户，可通过下面命令以用户B ssh到server B上了。e.g. ssh -l userB serverB。这样就使server A上的用户A就可以ssh以用户B的身份无需密码登陆到server B上了。</li>
</ol>
</li>
</ul>
<p>Q：如何通过在不危害安全的情况下通过防火墙使用rsync?</p>
<ul>
<li>解答如下：<br>这通常有两种情况，一种是服务器在防火墙内，一种是服务器在防火墙外。无论哪种情况，通常还是使用ssh，这时最好新建一个备份用户，并且配置sshd 仅允许这个用户通过RSA认证方式进入。如果服务器在防火墙内，则最好限定客户端的IP地址，拒绝其它所有连接。如果客户机在防火墙内，则可以简单允许防 火墙打开TCP端口22的ssh外发连接就ok了。</li>
</ul>
<p>Q：我能将更改过或者删除的文件也备份上来吗？</p>
<ul>
<li>当然可 以。你可以使用如：rsync -other -options -backupdir = ./backup-2000-2-13  …这样的命令来实现。这样如果源文件:/path/to/some/file.c改变了，那么旧的文件就会被移到./backup- 2000-2-13/path/to/some/file.c，这里这个目录需要自己手工建立起来</li>
</ul>
<p>Q：我需要在防火墙上开放哪些端口以适应rsync？</p>
<ul>
<li>视情况而定。rsync可以直接通过873端口的tcp连接传文件，也可以通过22端口的ssh来进行文件传递，但你也可以通过下列命令改变它的端口：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -A INPUT -p tcp -m state --state NEW  -m tcp --dport <span class="number">873</span> -j ACCEPT</span><br></pre></td></tr></table></figure>
<p><code>rsync --port 8730 otherhost::</code>或者<code>rsync -e &#39;ssh -p 2002&#39; otherhost:</code></p>
<p>Q：我如何通过rsync只复制目录结构，忽略掉文件呢？    </p>
<ul>
<li><code>rsync -av --include &#39;*/&#39; --exclude &#39;*&#39; source-dir dest-dir</code></li>
</ul>
<p>Q：为什么我总会出现”Read-only file system”的错误呢？    </p>
<ul>
<li>看看是否忘了设”read only = no”了</li>
</ul>
<p>Q：为什么我会出现’@ERROR: invalid gid’的错误呢？</p>
<ul>
<li>rsync使用时默认是用uid=nobody;gid=nobody来运行的，如果你的系统不存在nobody组的话，就会出现这样的错误，可以试试gid = ogroup或者其它</li>
</ul>
<p>Q：绑定端口873失败是怎么回事？</p>
<ul>
<li>如果你不是以root权限运行这一守护进程的话，因为1024端口以下是特权端口，会出现这样的错误。你可以用–port参数来改变。</li>
</ul>
<p>Q：为什么我认证失败？    </p>
<ul>
<li>从你的命令行看来：你用的是</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bash$ rsync -a <span class="number">144.16</span><span class="number">.251</span><span class="number">.213</span>::test test</span><br><span class="line">Password:</span><br><span class="line"><span class="decorator">@ERROR: auth failed on module test</span></span><br></pre></td></tr></table></figure>
<p>应该是没有以你的用户名登陆导致的问题，试试rsync -a max@144.16.251.213::test test</p>
<p>Q: 出现以下这个讯息, 是怎么一回事?    </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="decorator">@ERROR: auth failed on module xxxxx</span></span><br><span class="line">rsync: connection unexpectedly closed (<span class="number">90</span> bytes read so far)</span><br><span class="line">rsync error: error <span class="keyword">in</span> rsync protocol data stream (code <span class="number">12</span>) at io.c(<span class="number">150</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>这是因为密码设错了, 无法登入成功, 请再检查一下 rsyncd.secrets 中的密码设定, 二端是否一致?</li>
</ul>
<p>Q: 出现以下这个讯息, 是怎么一回事?    </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">password file must <span class="keyword">not</span> be other-accessible </span><br><span class="line">continuing without password file </span><br><span class="line">Password:</span><br></pre></td></tr></table></figure>
<ul>
<li>这表示 rsyncd.secrets 的档案权限属性不对, 应设为 600。请下 chmod 600 rsyncd.secrets</li>
</ul>
<p>Q: 出现以下这个讯息, 是怎么一回事?</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="decorator">@ERROR: chroot failed</span></span><br><span class="line">rsync: connection unexpectedly closed (<span class="number">75</span> bytes read so far)</span><br><span class="line">rsync error: error <span class="keyword">in</span> rsync protocol data stream (code <span class="number">12</span>) at io.c(<span class="number">150</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>这通常是您的 rsyncd.conf 中的 path 路径所设的那个目录并不存在所致.请先用 mkdir开设好备份目录.</li>
</ul>
<p>高并发数据实时同步方案小结<br>1。inotify+rsync 文件级别<br>2。drbd 文件系统级别<br>3。 第三方软件的同步功能， mysql, oracle, mongodb<br>4.。 程序双写<br>5。业务逻辑解决。（读写分离，备读不到，读主）</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/regular-expressions/" itemprop="url">
                  Regular Expressions
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2015-11-14T09:38:11+08:00" content="2015-11-14">
              2015-11-14
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分類於
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/python/" itemprop="url" rel="index">
                    <span itemprop="name">python</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/regular-expressions/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="regular-expressions/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        
          <span itemprop="articleBody">
            
              <p> 正则表达式是为处理大量字符串而定义的方法。<br> 正则表达式分基本正则表达式（Basic Regular Expressions,BERs）和扩展正则表达式（Extended Regular Expressions,EREs）. EREs基本包含BERs，而且还包含更多功能. EREs现在已经被应用于 Apache, PERL, PHP, python. 以及VI，emac,grep awk和sed…ERES现在基本已成流行，也是本文主要关注的重点   </p>
<h2 id="通用的定义">通用的定义</h2><p>  本文基本都会用下面几个概念：<strong>literal, metacharacter, target string, escape sequence, search expression</strong>. 下面来介绍下他们的定义</p>
<ol>
<li><p>literal:<br>literal 我们用来匹配或者用来搜索的可以是任意字符. 在表达式中写什么便会匹配到什么. 简单来说literal 便是你确切想要查找的内容</p>
</li>
<li><p>metacharacter:<br>metacharacter 便是一个或者多个不同于literal用法的拥有特殊意义的特殊字符. 例如 ^ (circumflex or caret) 便是一个metacharacter</p>
</li>
<li><p>target string:<br>target string 便是我们想要查找或者匹配到的内容</p>
</li>
<li><p>search expression:<br>也叫regular expression.  这是我们需要查到或者匹配内容的样式</p>
</li>
<li><p>escape sequence:<br>如果想把metacharacter当做literal来用便需要用到escape sequenc. 就是需要用 \ (backslash)把metacharacter 转义为普通的literal. 例如如果我们想要匹配 ^ 便要写成：<code>\^</code>  </p>
<p>本文都会用正则表达式来在下面两个字符串中匹配   </p>
</li>
</ol>
<blockquote>
<p>字符串1   Mozilla/4.0 (compatible; MSIE 5.0; Windows NT; DigExt)<br>字符串2   Mozilla/4.75 [en](X11;U;Linux2.2.16-22 i586)   </p>
</blockquote>
<hr>
<p> 一些简单的例子</p>
<table>
<thead>
<tr>
<th style="text-align:center">表达式</th>
<th style="text-align:left">匹配到的内容</th>
<th style="text-align:center">注释</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">m</td>
<td style="text-align:left">只有在字符串一中会在compatible里查找到m</td>
<td style="text-align:center">literal</td>
</tr>
<tr>
<td style="text-align:center">5 \[</td>
<td style="text-align:left">只有在字符串二中从4.7<em>5 [</em>en 匹配到 <strong>5 [</strong></td>
<td style="text-align:center">escape sequence</td>
</tr>
<tr>
<td style="text-align:center">a/4</td>
<td style="text-align:left">只会在字符串一中从Mozilla/4中匹配到<strong>a/4</strong></td>
<td style="text-align:center">literal</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="metacharacters">metacharacters</h3><p>  在RE中经常会用到很多特殊字符，每个字符在不同的位置拥有不同的意思，下面简单介绍几个常用的metacharacters</p>
<p>一些基本的元字符及各自的意思</p>
<table>
<thead>
<tr>
<th style="text-align:center">元字符</th>
<th style="text-align:left">特殊意义</th>
<th style="text-align:left">例子</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><strong>[ ]</strong></td>
<td style="text-align:left">匹配在方括号里面的任意1个字符</td>
<td style="text-align:left"><code>[12]</code> 便只会匹配1或者2, [0-9] 便会匹配任意一个数字</td>
</tr>
<tr>
<td style="text-align:center"><strong>-</strong></td>
<td style="text-align:left">在方括号里面dash的意思是range separator</td>
<td style="text-align:left">[0-9]` 相当于[0123456789]</td>
</tr>
<tr>
<td style="text-align:center"><strong>^</strong></td>
<td style="text-align:left">在放括號里caret是取反,不在中括号里是最开头</td>
<td style="text-align:left"><code>[^Ff]</code> 匹配除了f(大写与小写)的任意字符。<code>^Moz</code> 以Woz开头字符会从 ‘Mozilla’ 中找到</td>
</tr>
<tr>
<td style="text-align:center"><strong>$</strong></td>
<td style="text-align:left">只匹配结尾是literal的字符</td>
<td style="text-align:left"><code>fox$</code> 便会从 ‘silver fox’ 中找到</td>
</tr>
<tr>
<td style="text-align:center"><strong>.</strong></td>
<td style="text-align:left">在这个位置的任意字符</td>
<td style="text-align:left"><code>ton.</code> 便会从 ‘tonneau’ 中找到<strong>tons</strong> , 但不会从’wanton’ 里找到</td>
</tr>
<tr>
<td style="text-align:center"><strong>?</strong></td>
<td style="text-align:left">匹配前面的一个字符出现0次或者1次</td>
<td style="text-align:left"><code>colou?r</code> 便会找到<strong>color</strong>和<strong>colour</strong></td>
</tr>
<tr>
<td style="text-align:center">*</td>
<td style="text-align:left">匹配前面的一个字符出现0次或者多次</td>
<td style="text-align:left"><code>tre\*</code> (请忽略\ )便会找到 <code>tr</code>, <code>tre</code>, <code>tree</code> 。</td>
</tr>
<tr>
<td style="text-align:center"><strong>+</strong></td>
<td style="text-align:left">匹配前面的一个字符出现1次或者多次</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:center">{n}</td>
<td style="text-align:left">匹配前面的字符或者出现n次</td>
<td style="text-align:left"><code>[1-9]{3}-[0-9]{4}</code> 便用找到像123-4567形式的数字</td>
</tr>
<tr>
<td style="text-align:center">{n,m}</td>
<td style="text-align:left">匹配前面的字符至少出现n到m次</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:center">{n,m}? ,+?, *?, ??</td>
<td style="text-align:left">让{n,m}, *, +, ?非貪婪匹配(non-greed)</td>
<td style="text-align:left">字符串’aaaaa’, a{3,4}将会匹配５个a，　而a{3,5}?便只会匹配３个a</td>
</tr>
<tr>
<td style="text-align:center">()</td>
<td style="text-align:left">子表达式</td>
<td style="text-align:left">可以向后引用</td>
</tr>
<tr>
<td style="text-align:center">竖线</td>
<td style="text-align:left">可以匹配前面的字符或者后面的字符</td>
</tr>
</tbody>
</table>
<p>gr(a|e)y`可以找到 ‘gray’ 或 ‘grey’</p>
<p> 举例  </p>
<blockquote>
<p>字符串1   Mozilla/4.0 (compatible; MSIE 5.0; Windows NT; DigExt)<br>字符串2   Mozilla/4.75 [en](X11;U;Linux2.2.16-22 i586)   </p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align:center">表达式</th>
<th style="text-align:left">字符串一</th>
<th style="text-align:left">字符串二</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">[^A-M]in</td>
<td style="text-align:left">会从Windows里找到 <strong>Win</strong></td>
<td style="text-align:left">因为排队A－M所以不会匹配到Linux</td>
</tr>
<tr>
<td style="text-align:center">[a-z])$</td>
<td style="text-align:left">会从 DigiExt)里找到<strong>t）</strong></td>
<td style="text-align:left">因为结尾是数字所以不会匹配到</td>
</tr>
<tr>
<td style="text-align:center">.in</td>
<td style="text-align:left">会从 Windows 里打到 <strong>Win</strong></td>
<td style="text-align:left">会从Linux里找到<strong>Lin</strong></td>
</tr>
<tr>
<td style="text-align:center">(.*l</td>
<td style="text-align:left">会匹配到<strong>(compatibl</strong></td>
<td style="text-align:left">“(“后面没有l所以不会匹配到</td>
</tr>
<tr>
<td style="text-align:center">[Xx][0-9a-z]{2}</td>
<td style="text-align:left">无匹配虽然有小x但是后面t并没有重复两次</td>
<td style="text-align:left">会找到X11</td>
</tr>
<tr>
<td style="text-align:center">^([L-Z]in)</td>
<td style="text-align:left">没有以L-Z开头的字符所以无匹配</td>
<td style="text-align:left">Lin不在字符串的开头无匹配</td>
</tr>
</tbody>
</table>
<p><code>((4\.[0-3])\|(2\.[0-3]))</code> 可以在字符串1中找到4.0，在字符串2中找到2.2</p>
<h3 id="POSIX_Character_Class_Definitions">POSIX Character Class Definitions</h3><p>  POSIX 1003.2第2.8.3.2(6) 定义了一些字符集来表示特定的范围, 虽然看起来很奇怪但是呢也有一些优点的. 下面的内容引用LC_CTYPE POSIX定义</p>
<ul>
<li>[:digit:] 相当于[0-9]</li>
<li>[:alnum:] 相当于[0-9a-zA-Z]</li>
<li>[:alpha:] 相当于[a-zA-Z]</li>
<li>[:blank:] 空格或者制表符</li>
<li>[:xdigit:] 十六进制符相当于[0-9a-fA-F]</li>
<li>[:punct:] 标点符号 . , “ ‘ ? ! ; : # $ % &amp; ( ) * + - / &lt; &gt; = @ [ ] \ ^ _ { } | ~</li>
<li>[:print:] 任何可打印的字符</li>
<li>[:space:] 任何空格(space, tab, NL, FF, VT, CR). 很多时候用 \s.</li>
<li>[:graph:] 排除空格 (SPACE, TAB). Many system abbreviate as \W.</li>
<li>[:upper:] 相当于[A-Z]</li>
<li>[:lower:] 相当于[a-z]</li>
<li>[:cntrl:] 控制字符 NL CR LF TAB VT FF NUL SOH STX EXT EOT ENQ ACK SO SI DLE DC1 DC2 DC3 DC4 NAK SYN ETB CAN EM SUB ESC IS1 IS2 IS3 IS4 DEL.</li>
</ul>
<h3 id="一些扩展和缩写">一些扩展和缩写</h3><p>  有些程序（ruby, python, js, php）支持扩展和缩写正则表达式, 这些扩展将在下面列出，一般来说这些扩展都是由PERL（perl compatible regular Expressions） 定义。</p>
<ol>
<li>Character Class Abbreviations</li>
</ol>
<ul>
<li>\d 匹配数字，(equivalent of POSIX [:digit:])</li>
<li>\D 匹配任意非数字字符(equivalent of POSIX [^[:digit:]])</li>
<li>\s 匹配空格字符(space, tab etc.). (equivalent of POSIX [:space:] EXCEPT VT is not recognized)</li>
<li>\S 匹配任何非空格字符(space, tab). (equivalent of POSIX [^[:space:]])</li>
<li>\w 匹配任何数字与字母（大小）字符(equivalent of POSIX [:alnum:])</li>
<li>\W 匹配任何非数字与字母（大小）字符 (equivalent of POSIX [^[:alnum:]])</li>
</ul>
<ol>
<li>Positional Abbreviations</li>
</ol>
<ul>
<li>\b 单词边界，<code>\bxx</code>匹配以xx开始的词，<code>xx\b</code>匹配以xx结束的词.  <code>\bton\b</code> 可以找到ton但是找不到tons, <code>\bton</code>就会找到 tons.</li>
<li>\B 非单词边界，匹配任意不以xx开始或者结束的词. <code>\Bton\B</code>会找到wantons找不到tons, <code>ton\B</code>会找到 wantons 和 tons.</li>
</ul>
<p><img src="/images/regular-expression.png" alt="regular expression"></p>
<hr>
<h2 id="python_中的re包，">python 中的re包，</h2><p>　python里的re使用方法, 后面的语法是结合complie使用pos是position的缩写意思是从什么位置开始匹配，什么位置结束。</p>
<ul>
<li><strong>re.compile(pattern, flags=0)</strong>   先把pattern编译然后再用正则表达式的方法调用  </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>prog = re.compile(pattern)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>result = prog.match(string)</span><br></pre></td></tr></table></figure>
<p>相当于</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>result = re.match(pattern, string)</span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>re.search(pattern, string, flags=0) , regex.search(string[, pos[, endpos]])</strong><br>扫描整个字符串找到第一个regular expression pattern 匹配到的位置然后返回符合pattern的match object,　如果未找到便返回　None .</p>
</li>
<li><p><strong>re.match(pattern, string, flags=0)　　regex.match(string[, pos[, endpos]])</strong><br>如果在这个string的开始匹配到字符，那么就返回相应的match object,　匹配不到便会返回　None  </p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>m=re.search(<span class="string">"a\w+"</span>,<span class="string">"bcdfa\na1b2c3"</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>n=re.match(<span class="string">"a\w+"</span>,<span class="string">"bcdfa\na1b2c3"</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>m.group()</span><br><span class="line"><span class="string">'a1b2c3'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>print(n)</span><br><span class="line"><span class="keyword">None</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>re.split(pattern, string, maxsplit=0, flags=0)，　regex.split(string, maxsplit=0)</strong><br>用能够匹配到的字符来分隔字符串，maxsplit默认是最大分隔，指定数字后为最大分隔数</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>re.split(<span class="string">'\W+'</span>, <span class="string">'Words, words, words.'</span>)</span><br><span class="line">[<span class="string">'Words'</span>, <span class="string">'words'</span>, <span class="string">'words'</span>, <span class="string">''</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>re.split(<span class="string">'(\W+)'</span>, <span class="string">'Words, words, words.'</span>)</span><br><span class="line">[<span class="string">'Words'</span>, <span class="string">', '</span>, <span class="string">'words'</span>, <span class="string">', '</span>, <span class="string">'words'</span>, <span class="string">'.'</span>, <span class="string">''</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>re.split(<span class="string">'\W+'</span>, <span class="string">'Words, words, words.'</span>, <span class="number">1</span>)</span><br><span class="line">[<span class="string">'Words'</span>, <span class="string">'words, words.'</span>]</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>re.split(<span class="string">'[a-f]+'</span>, <span class="string">'0a3B9'</span>, flags=re.IGNORECASE)</span><br><span class="line">[<span class="string">'0'</span>, <span class="string">'3'</span>, <span class="string">'9'</span>]</span><br></pre></td></tr></table></figure>
<p>如果有字符串的形状找到一个或者多个分隔符，那么在结果中便会以一个空字符开始，结尾有字符也是一样的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>re.split(<span class="string">'(\W+)'</span>, <span class="string">'...words, words...'</span>)</span><br><span class="line">[<span class="string">''</span>, <span class="string">'...'</span>, <span class="string">'words'</span>, <span class="string">', '</span>, <span class="string">'words'</span>, <span class="string">'...'</span>, <span class="string">''</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>re.findall(pattern, string, flags=0), regex.findall(string[, pos[, endpos]])</strong><br>用列表的方式返回匹配到的字符，</p>
</li>
<li><p><strong>re.finditer(pattern, string, flags=0), regex.finditer(string[, pos[, endpos]])</strong><br>用迭代的方式返回匹配到的字符，</p>
</li>
<li><p><strong>re.sub(pattern, repl, string, count=0, flags=0), regex.sub(repl, string, count=0)</strong><br>把用样式匹配到的字符换成repl。如果没有匹配到字符便返回原string。　repl可以是字符，也可以是函数，当repl是一个字符串时，可以使用\id或\g\<id\>、\g\<name\>引用分组，但不能使用编号0。 </name\></id\></p>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dashrepl</span><span class="params">(matchobj)</span>:</span></span><br><span class="line">	<span class="keyword">if</span> matchobj.group(<span class="number">0</span>) == <span class="string">'-'</span>: </span><br><span class="line">		<span class="keyword">return</span> <span class="string">' '</span></span><br><span class="line">	<span class="keyword">else</span>: </span><br><span class="line">		<span class="keyword">return</span> <span class="string">'-'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>re.sub(<span class="string">'-&#123;1,2&#125;'</span>, dashrepl, <span class="string">'pro----gram-files'</span>)</span><br><span class="line"><span class="string">'pro--gram files'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>re.sub(<span class="string">r'\sAND\s'</span>, <span class="string">' &amp; '</span>, <span class="string">'Baked Beans And Spam'</span>, flags=re.IGNORECASE)</span><br><span class="line"><span class="string">'Baked Beans &amp; Spam'</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>re.subn(pattern, repl, string, count=0, flags=0)</strong><br>与sub用法一亲但是返回一个数组(new_string, number_of_subs_made).</p>
</li>
<li><p><strong>re.escape(string)</strong><br>Escape all the characters in pattern except ASCII letters, numbers and ‘_’. This is useful if you want to match an arbitrary literal string that may have regular expression metacharacters in it.</p>
</li>
</ul>
<h3 id="Match_Objects">Match Objects</h3><p>  match object提供了很多方法与属性</p>
<ul>
<li><strong>match.expand(template)</strong> 将匹配到的分组代入template中然后返回。template中可以使用\id或\g\<id\>、\g\<name\>引用分组，但不能使用编号0。\id与\g\<id\>是等价的；但\10将被认为是第10个分组，如果你想表达\1之后是字符’0’，只能使用\g\<1\>0。</1\></id\></name\></id\></li>
</ul>
<ul>
<li><strong>match.group([group1, …])</strong> 获得一个或多个分组截获的字符串；指定多个参数时将以元组形式返回。如果里面无参数默认为０，返回所有匹配的子符串</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>m = re.match(<span class="string">r"(\w+) (\w+)"</span>, <span class="string">"Isaac Newton, physicist"</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>m.group(<span class="number">0</span>)       <span class="comment"># The entire match</span></span><br><span class="line"><span class="string">'Isaac Newton'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>m.group(<span class="number">1</span>)       <span class="comment"># The first parenthesized subgroup.</span></span><br><span class="line"><span class="string">'Isaac'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>m.group(<span class="number">2</span>)       <span class="comment"># The second parenthesized subgroup.</span></span><br><span class="line"><span class="string">'Newton'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>m.group(<span class="number">1</span>, <span class="number">2</span>)    <span class="comment"># Multiple arguments give us a tuple.</span></span><br><span class="line">(<span class="string">'Isaac'</span>, <span class="string">'Newton'</span>)</span><br></pre></td></tr></table></figure>
<p>如果使用(?P\<name\>…)表达式，那么便会吧每个子组用name来命名，</name\></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>m = re.match(<span class="string">r"(?P&lt;first_name&gt;\w+) (?P&lt;last_name&gt;\w+)"</span>, <span class="string">"Malcolm Reynolds"</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>m.group(<span class="string">'first_name'</span>)</span><br><span class="line"><span class="string">'Malcolm'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>m.group(<span class="string">'last_name'</span>)</span><br><span class="line"><span class="string">'Reynolds'</span></span><br></pre></td></tr></table></figure>
<p>这里也可以用数字来提取</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>m.group(<span class="number">1</span>)</span><br><span class="line"><span class="string">'Malcolm'</span></span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>m.group(<span class="number">2</span>)</span><br><span class="line"><span class="string">'Reynolds'</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>match.groups(default=None)</strong> 将所有匹配到的子组用tuple 的方式返回，</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>m = re.match(<span class="string">r"(\d+)\.(\d+)"</span>, <span class="string">"24.1632"</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>m.groups()</span><br><span class="line">(<span class="string">'24'</span>, <span class="string">'1632'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>match.groupdict(default=None)</strong>  将所有匹配到的子组用dic　的方式返回，key 是子组的名字.</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="prompt">&gt;&gt;&gt; </span>m = re.match(<span class="string">r"(?P&lt;first_name&gt;\w+) (?P&lt;last_name&gt;\w+)"</span>, <span class="string">"Malcolm Reynolds"</span>)</span><br><span class="line"><span class="prompt">&gt;&gt;&gt; </span>m.groupdict()</span><br><span class="line">&#123;<span class="string">'first_name'</span>: <span class="string">'Malcolm'</span>, <span class="string">'last_name'</span>: <span class="string">'Reynolds'</span>&#125;</span><br></pre></td></tr></table></figure>
<h2 id="re_in_linux">re in linux</h2><p>在linux中使用re请参见另一篇文章 linux三剑客</p>

            
          </span>
        
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    

  </section>

  


        </div>

        


        

      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/avatar.jpg" alt="sandow" itemprop="image"/>
          <p class="site-author-name" itemprop="name">sandow</p>
        </div>
        <p class="site-description motion-element" itemprop="description">博學   慎思   笃行</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">9</span>
              <span class="site-state-item-name">文章</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">3</span>
              <span class="site-state-item-name">分類</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">8</span>
              <span class="site-state-item-name">標籤</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="http://github.com/gsandow" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/jkshiqiao" target="_blank">
                  
                    <i class="fa fa-weibo"></i> Weibo
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.douban.com/people/gsandow/" target="_blank">
                  
                    <i class="fa fa-douban"></i> Douban
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
            <p class="site-author-name">Links</p>
            
              <span class="links-of-author-item">
                <a href="http://coursera.org/" target="_blank">Coursera</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.edx.org" target="_blank">edx</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.52nlp.cn/" target="_blank">52nlp</a>
              </span>
            
          
        </div>

      </section>

      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sandow</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    sandow
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"magdre"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     


    
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  

  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>

  
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  
  

</body>
</html>
