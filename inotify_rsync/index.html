<!doctype html>
<html class="theme-next   use-motion ">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  
    <link href='//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
  



<link href="/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/stylesheet/main.css" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="linux," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.2" />






<meta name="description" content="主机规划


服务器
外网IP

内网IP
主机名称




A1-nginx 负载服务器
10.0.0.5/24

127.16.1.5/24
lb01


A2-nginx 负载服务器
10.0.0.6/24

127.16.1.6/24
lb02


B1-apache软件web服务器
10.0.0.7/24

127.16.1.7/24
web02


B2-apache软件web服务器">
<meta property="og:type" content="article">
<meta property="og:title" content="rsync + inotify 实现实时同步">
<meta property="og:url" content="gsandow.github.io/inotify_rsync/index.html">
<meta property="og:site_name" content="听雨阁">
<meta property="og:description" content="主机规划


服务器
外网IP

内网IP
主机名称




A1-nginx 负载服务器
10.0.0.5/24

127.16.1.5/24
lb01


A2-nginx 负载服务器
10.0.0.6/24

127.16.1.6/24
lb02


B1-apache软件web服务器
10.0.0.7/24

127.16.1.7/24
web02


B2-apache软件web服务器">
<meta property="og:updated_time" content="2015-11-14T13:17:53.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="rsync + inotify 实现实时同步">
<meta name="twitter:description" content="主机规划


服务器
外网IP

内网IP
主机名称




A1-nginx 负载服务器
10.0.0.5/24

127.16.1.5/24
lb01


A2-nginx 负载服务器
10.0.0.6/24

127.16.1.6/24
lb02


B1-apache软件web服务器
10.0.0.7/24

127.16.1.7/24
web02


B2-apache软件web服务器">



<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: '',
    sidebar: 'post',
    motion: true
  };
</script>

  <title> rsync + inotify 实现实时同步 | 听雨阁 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-70294115-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?0f24b8759b65280643922c9035ac6bdf";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">听雨阁</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">stay hungry, stay foolish</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            分類
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            標籤
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            關於
          </a>
        </li>
      

      
      
        <li class="menu-item menu-item-search">
          <a href="#" class="st-search-show-outputs">
            
              <i class="menu-item-icon fa fa-search icon-next-search"></i> <br />
            
            檢索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'MA224RsRYTYmje5Y13_h','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                rsync + inotify 实现实时同步
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            發表於
            <time itemprop="dateCreated" datetime="2015-11-14T21:17:53+08:00" content="2015-11-14">
              2015-11-14
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp; 分類於
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/linux/" itemprop="url" rel="index">
                    <span itemprop="name">linux</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/inotify_rsync/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="inotify_rsync/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

        </div>
      </header>
    


    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><h1 id="主机规划">主机规划</h1><table>
<thead>
<tr>
<th style="text-align:left">服务器</th>
<th style="text-align:left">外网IP</th>
<th style="text-align:left"></th>
<th style="text-align:left">内网IP</th>
<th style="text-align:left">主机名称</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">A1-nginx 负载服务器</td>
<td style="text-align:left">10.0.0.5/24</td>
<td style="text-align:left"></td>
<td style="text-align:left">127.16.1.5/24</td>
<td style="text-align:left">lb01</td>
</tr>
<tr>
<td style="text-align:left">A2-nginx 负载服务器</td>
<td style="text-align:left">10.0.0.6/24</td>
<td style="text-align:left"></td>
<td style="text-align:left">127.16.1.6/24</td>
<td style="text-align:left">lb02</td>
</tr>
<tr>
<td style="text-align:left">B1-apache软件web服务器</td>
<td style="text-align:left">10.0.0.7/24</td>
<td style="text-align:left"></td>
<td style="text-align:left">127.16.1.7/24</td>
<td style="text-align:left">web02</td>
</tr>
<tr>
<td style="text-align:left">B2-apache软件web服务器</td>
<td style="text-align:left">10.0.0.8/24</td>
<td style="text-align:left"></td>
<td style="text-align:left">127.16.1.8/24</td>
<td style="text-align:left">web01</td>
</tr>
<tr>
<td style="text-align:left">C3-My Sql 数据库服务器</td>
<td style="text-align:left"><code>10.0.0.51/24</code></td>
<td style="text-align:left"></td>
<td style="text-align:left">127.16.1.51/24</td>
<td style="text-align:left">Db01</td>
</tr>
<tr>
<td style="text-align:left">C1-NFS 存储服务器</td>
<td style="text-align:left"><code>10.0.0.31/24</code></td>
<td style="text-align:left"></td>
<td style="text-align:left">127.16.1.31/24</td>
<td style="text-align:left">NFS01</td>
</tr>
<tr>
<td style="text-align:left">C2-rsync 数据库服务器</td>
<td style="text-align:left"><code>10.0.0.41/24</code></td>
<td style="text-align:left"></td>
<td style="text-align:left">127.16.1.41/24</td>
<td style="text-align:left">Backup</td>
</tr>
<tr>
<td style="text-align:left">X-管理服务器</td>
<td style="text-align:left"><code>10.0.0.61/24</code></td>
<td style="text-align:left"></td>
<td style="text-align:left">127.16.1.61/24</td>
<td style="text-align:left">m01</td>
</tr>
</tbody>
</table>
<blockquote>
<p>红色仅为虚拟机中测试所用 <br><br>机房根据实际需求配置</p>
</blockquote>
<h2 id="克隆虚拟机并配置网卡">克隆虚拟机并配置网卡</h2><ol>
<li>编辑eth0的配置文件：<code>vi /etc/sysconfig/network-scripts/ifcfg-eth0</code>，删除HWADDR地址那一行及UUID的行如下：</li>
</ol>
<pre><code>HWADDR=<span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:<span class="number">08</span>:<span class="number">28</span>:<span class="number">9f</span>     
UUID=cee39dbb-<span class="number">6</span>a10-<span class="number">4425</span>-<span class="number">9</span>daf-<span class="number">768</span>b6e79a9c9
</code></pre><ol>
<li>清空 /etc/udev/rules.d/70-persistent-net.rules</li>
<li>重启</li>
</ol>
<h2 id="RSYNC_数据库服务器">RSYNC 数据库服务器</h2><p>rsync, (remote synchronize) 是一个实现同步功能的软件，它在同步文件的同时，可以保持原来文件的权限，时间，软硬链接等附加信息。 rsync是用rsync 算法提供了一个客户机和远程文件服务器的文件同步的快速方法，而且可以通过ssh方式来传输文件，这样保密也非常好。主要用于远程数据备份与同步。 可以实现全备及增量备份，也可以本地数据同步。 在Centos5中rsync的版本是2.X，是把所有文件比对一遍后进行同步。在CentOs6中rsync的版本是3.0，是一边比对差异一边进行同步。而这里我们用的是3.0</p>
<p>首先检查rsync看是否安装，及安装的版本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ rpm -qa rsync</span><br><span class="line">rsync-<span class="number">3.0</span><span class="number">.6</span>-<span class="number">12.</span>el6.x86_64</span><br></pre></td></tr></table></figure>
<p>rsync有三种模式，分别是本地，ssh远程同步，daemon模式</p>
<ul>
<li><p>Local:  <code>rsync [OPTION...] SRC... [DEST]</code></p>
</li>
<li><p>Access via remote shell:</p>
<ul>
<li>Pull: <code>rsync [OPTION...] [USER@]HOST:SRC... [DEST]</code></li>
<li>Push: <code>rsync [OPTION...] SRC... [USER@]HOST:DEST</code></li>
</ul>
</li>
<li><p>Access via rsync daemon:</p>
<ul>
<li>Pull: <code>rsync [OPTION...] [USER@]HOST::SRC... [DEST]</code>    <pre><code>`rsync <span class="string">[OPTION...]</span> rsync://<span class="string">[USER@]</span>HOST<span class="string">[:PORT]</span>/SRC... <span class="string">[DEST]</span>`
</code></pre></li>
<li>Push: <code>rsync [OPTION...] SRC... [USER@]HOST::DEST</code>    <pre><code>`rsync <span class="string">[OPTION...]</span> SRC... rsync://<span class="string">[USER@]</span>HOST<span class="string">[:PORT]</span>/DEST`
</code></pre></li>
</ul>
</li>
</ul>
<p>都是把SRC的数据同步到DEST. 如果没有DEST，但会把SRC的文件列出来而不copy</p>
<p>rsync 参数说明：</p>
<ul>
<li>–delete;     delete extraneous files from dest dirs 删除目标文件中多余的文件</li>
<li>–exclude=PATTERN ;      exclude files matching PATTERN 排除特定文件 –exclude={a,b}</li>
<li>–exclude-from=FILE;     read exclude patterns from FILE  ,–exclude-from=/tmp/exclude.txt</li>
<li>-z, –compress    ;          compress file data during the transfer</li>
<li>-v, –verbose               increase verbosity</li>
<li>-a, –archive               archive mode; equals -rlptgoD (no -H,-A,-X)</li>
<li>–bwlimit=KBPS          limit I/O bandwidth; KBytes per second </li>
<li>–partial               keep partially transferred files 断点续传</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#排除单个文件：</span></span><br><span class="line">$ rsync -auvrtzopgP --progress --exclude=a /backup/ rsync_backup@<span class="number">172.16</span><span class="number">.1</span><span class="number">.41</span>::backup --password-file=/etc/rsync.password</span><br><span class="line"></span><br><span class="line"><span class="comment">#排除多个文件：</span></span><br><span class="line">$ rsync -avz --exclude=&#123;a,b&#125; /backup/ rsync_backup@<span class="number">172.16</span><span class="number">.1</span><span class="number">.41</span>::backup --password-file=/etc/rsync.password</span><br><span class="line"></span><br><span class="line">$ rsync -avz --exclude-<span class="keyword">from</span>=paichu.log /backup/ rsync_backup@<span class="number">172.16</span><span class="number">.1</span><span class="number">.41</span>::backup --password-file=/etc/rsync.password</span><br></pre></td></tr></table></figure>
<h3 id="本地备份">本地备份</h3><p>本地 模式，相当于copy 或者rm<br>比如<code>$ rsync -auvrtzopgP /tmp/ /backup/</code> <br><br>此命令就会把tmp目录下的文件全部复制到backup目录下面， 如果加上<code>--delete</code>，此参数的意思是把目标目录与源目录同步，当目标目录里有多于源目录的文件就会删除，也就是源目录是啥样，目标目录就是啥样。如果源目录为空，目标目录也会被清空。我们一般都会在目录后面加<code>/</code>意思是目录下面，如果不加就直接把目录复制过去了，在远程的时候也是一样的。<br><br>保持属性： -avz  相当于 cp -rp<br><br><br></p>
<h3 id="通过shell远程传输(remote)">通过shell远程传输(remote)</h3><p>远程拷贝；相当于ssh带的scp命令，但又优于scp命令的功能。scp每次都是全量拷贝。rsync可以增量拷贝。 当源路径，或目的路径后面包含一个卡号</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ rsync -avz -e 'ssh -p 22' root@172.16.1.41:/tmp/ /tmp/</span><br><span class="line">The authenticity of host '172.16.1.41 (172.16.1.41)' can't be established.</span><br><span class="line">RSA key fingerprint is 97:b9:1f:95:8b:7d:ae:59:27:4a:d4:b3:98:ae:c1:77.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added '172.16.1.41' (RSA) to the list of known hosts.</span><br><span class="line">root@172.16.1.41's password: </span><br><span class="line">receiving incremental file list</span><br><span class="line">created directory /temp</span><br><span class="line">./</span><br><span class="line">hosts</span><br><span class="line">.ICE-unix/</span><br><span class="line"></span><br><span class="line">sent 37 bytes  received 184 bytes  9.02 bytes/sec</span><br><span class="line">total size is 220  speedup is 1.00</span><br></pre></td></tr></table></figure>
<p><br><br>此命令便是把ip为172.16.1.41的主机里tmp目录下的文件传到本地的/tmp/下。这里 <code>ssh -p 22</code>命令用于指定端口，默认就是22，-e 这个参数可以不写直接 <code>rsync -avz root@172.16.1.41:/tmp/ /tmp/</code>便可以把41的文件复制过来。且这里是交互式，手动备份与推送，十分不方便。</p>
<p>这里有个问题，如果我们用其它用户推或者拉，的时候需要共享文件的所属主与所属组都对该用户对应</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@NFS</span> tmp]<span class="variable">$ </span>rsync -avz /data/ sandow<span class="variable">@172</span>.<span class="number">16.1</span>.<span class="number">41</span><span class="symbol">:/data/</span></span><br></pre></td></tr></table></figure>
<p>此命令是把本地data目录下的文件推到服务器IP为：41下的data目录下。这里两个data目录都要具有对应主机用户的读取执行写入权限，最好的办法就是把该目录的所属主，所属组改为对应的用户</p>
<h3 id="daemon_模式，">daemon 模式，</h3><p>daemon模式需要配置文件，使用<code>rsync --daemon</code>启动进程，使用独立的进程方式传输文件，默认端口是873。</p>
<p>这里需要两台服务器做测试环境，服务器端名为backup, ip为172.16.1.41主要用于存放数据. 客户端(NFS01)IP为172.16.1.31 主要用于向服务器推送（备份）拉回（还原）数据。然后结合crontab实现实时自动备份同步。 </p>
<h4 id="服务端的配置">服务端的配置</h4><p>首先我们来配置rsync的主配置文件 rsyncd.conf，默认情况下该文件不存在需要创建，我们也可以使用<code>man rsyncd.conf</code>来查看主配置文件里的参数与说明。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@backup ~]$ cat /etc/rsyncd.conf</span><br><span class="line"><span class="comment">#Rsync server</span></span><br><span class="line"><span class="comment">#created by sandow at 2015-11-05</span></span><br><span class="line"><span class="comment">#rsyncd.conf start#</span></span><br><span class="line">uid = rsync		//相当于nfsnobody 客户端连过来具备什么样的权限默认是不存在的</span><br><span class="line">gid = rsync		//相当于nfsnobody</span><br><span class="line">use chroot = no		//   程序出现问题就会开启 开启给个空目录就行</span><br><span class="line">max connections = <span class="number">200</span>		//客户端连接数 可以同时</span><br><span class="line">timeout = <span class="number">300</span>        //超时 这是服务端 客户端连过来最多多久后就断掉</span><br><span class="line">strict modes=yes</span><br><span class="line">port=<span class="number">873</span></span><br><span class="line">pid file = /var/run/rstbcd.pid	//PID就是进程号唯一标识进程,进程号放文件里面</span><br><span class="line">lock file = /var/run/rsync.lock		//锁文件</span><br><span class="line">log file = /var/log/rsyncd.log		//日志文件，出问题在这里看</span><br><span class="line">hosts allow = <span class="number">172.16</span><span class="number">.1</span><span class="number">.0</span>/<span class="number">24</span>		//允许ip</span><br><span class="line">hosts deny = <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">32</span>		//拒绝</span><br><span class="line">secrets file = /etc/rsync.password		//存放用户和密码文件</span><br><span class="line"></span><br><span class="line">[backup]		//模块，调用下面服务</span><br><span class="line">comment=backup server by liuchunhao at <span class="number">2015</span>-<span class="number">11</span>-<span class="number">05</span>		//注释</span><br><span class="line">path = /backup		//共享目录</span><br><span class="line">read only = false		//可读写</span><br><span class="line">ignore errors		//忽略错误</span><br><span class="line">auth users = rsync_backup		//远程连接的用户，虚拟用户和系统用户没关系</span><br><span class="line">uid=rsync_backup</span><br><span class="line">gid=rsync_backup</span><br><span class="line">list = false		//不让远程列表，不让看服务端有什么</span><br><span class="line">secrets file=/etc/rsync.password</span><br></pre></td></tr></table></figure>
<p>配置好rsyncd.conf后便接下来就可以创建对应用户、目录与密码文件</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@backup</span> ~]<span class="variable">$ </span>useradd rsync -s /sbin/nologin -<span class="constant">M</span></span><br><span class="line">[root<span class="variable">@backup</span> ~]<span class="variable">$ </span>id rsync</span><br><span class="line">uid=<span class="number">504</span>(rsync) gid=<span class="number">504</span>(rsync) groups=<span class="number">504</span>(rsync)</span><br><span class="line">[root<span class="variable">@backup</span> ~]<span class="variable">$ </span>mkdir -p /backup</span><br><span class="line">[root<span class="variable">@backup</span> ~]<span class="variable">$ </span>chown -<span class="constant">R</span> rsync.rsync /backup/</span><br><span class="line">[root<span class="variable">@backup</span> ~]<span class="variable">$ </span>ls -ld /backup/              </span><br><span class="line">drwxr-xr-t. <span class="number">3</span> rsync rsync <span class="number">4096</span> <span class="constant">Nov</span> <span class="number">12</span> <span class="number">06</span><span class="symbol">:</span><span class="number">53</span> /backup/</span><br></pre></td></tr></table></figure>
<p>创建密码文件，并且修改属性为600</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@backup</span> ~]<span class="variable">$ </span>echo <span class="string">"rsync_backup:oldboy"</span> &gt;<span class="regexp">/etc/rsync</span>.password</span><br><span class="line">[root<span class="variable">@backup</span> ~]<span class="variable">$ </span>cat /etc/rsync.password</span><br><span class="line"><span class="symbol">rsync_backup:</span>oldboy</span><br><span class="line">[root<span class="variable">@backup</span> ~]<span class="variable">$ </span>chmod <span class="number">600</span> /etc/rsync.password</span><br><span class="line">[sandow<span class="variable">@backup</span> ~]<span class="variable">$ </span>ll /etc/rsync.password       </span><br><span class="line">-rw------- <span class="number">1</span> root root <span class="number">20</span> <span class="number">11</span>月  <span class="number">6</span> <span class="number">16</span><span class="symbol">:</span><span class="number">12</span> /etc/rsync.password</span><br></pre></td></tr></table></figure>
<p>修改/etc/xinetd.d/rsync 文件，把disable 改为no,这应该是最新版本的linux才会有此文件。所以没有的可以不配置</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># default: off</span><br><span class="line"># description: The rsync server is a good addition to an ftp server, as it \</span><br><span class="line">#	allows crc checksumming etc.</span><br><span class="line">service rsync</span><br><span class="line">&#123;</span><br><span class="line">	disable	= no</span><br><span class="line">	flags		= IPv6</span><br><span class="line">	socket_type     = stream</span><br><span class="line">	wait            = no</span><br><span class="line">	user            = root</span><br><span class="line">	server          = /usr/bin/rsync</span><br><span class="line">	server_args     = --daemon</span><br><span class="line">	log_on_failure  += USERID</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置好后便可以启动rsync daemon守护进程了</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[sandow<span class="variable">@backup</span> tmp]<span class="variable">$ </span>rsync --daemon</span><br><span class="line"></span><br><span class="line">[sandow<span class="variable">@backup</span> tmp]<span class="variable">$ </span>ps -ef|grep rsync |grep -v grep</span><br><span class="line">root       <span class="number">2370</span>      <span class="number">1</span>  <span class="number">0</span> <span class="number">01</span><span class="symbol">:</span><span class="number">57</span> ?        <span class="number">00</span><span class="symbol">:</span><span class="number">00</span><span class="symbol">:</span><span class="number">00</span> rsync --daemon</span><br><span class="line"></span><br><span class="line">[sandow<span class="variable">@backup</span> tmp]<span class="variable">$ </span>netstat -lntup|grep rsync</span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span><span class="symbol">:</span><span class="number">873</span>                 <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span><span class="symbol">:*</span>                   <span class="constant">LISTEN</span>      <span class="number">2370</span>/rsync          </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="symbol">:</span><span class="symbol">:</span><span class="symbol">:</span><span class="number">873</span>                      <span class="symbol">:</span><span class="symbol">:</span><span class="symbol">:*</span>                        <span class="constant">LISTEN</span>      <span class="number">2370</span>/rsync</span><br></pre></td></tr></table></figure>
<p>然后让rsync开机自动启动：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo <span class="string">"/usr/bin/rsync --daemon"</span> <span class="prompt">&gt;&gt;</span>/etc/rc.local</span><br></pre></td></tr></table></figure>
<p>这里需要注意的是要让端口873通过防火墙</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -m state --state <span class="constant">NEW</span>  -m tcp --dport <span class="number">873</span> -j <span class="constant">ACCEPT</span></span><br><span class="line"><span class="variable">$ </span>iptables -<span class="constant">L</span>  查看一下防火墙是不是打开了 <span class="number">873</span>端口</span><br></pre></td></tr></table></figure>
<h4 id="客户端的配置">客户端的配置</h4><p>客户端的配置很简单，仅需要增加一个密码文件并把权限改为600</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@NFS</span> tmp]<span class="variable">$ </span>echo <span class="string">"oldboy"</span> &gt;<span class="regexp">/etc/rsync</span>.password</span><br><span class="line">[root<span class="variable">@NFS</span> tmp]<span class="variable">$ </span>chmod <span class="number">600</span> /etc/rsync.password </span><br><span class="line">[root<span class="variable">@NFS</span> tmp]<span class="variable">$ </span>ll /etc/rsync.password </span><br><span class="line">-rw-------. <span class="number">1</span> root root <span class="number">7</span> <span class="constant">Nov</span> <span class="number">12</span> <span class="number">02</span><span class="symbol">:</span><span class="number">03</span> /etc/rsync.password</span><br><span class="line">[root<span class="variable">@NFS</span> tmp]<span class="variable">$ </span>cat /etc/rsync.password </span><br><span class="line">oldboy</span><br></pre></td></tr></table></figure>
<h4 id="备份数据以及自动备份">备份数据以及自动备份</h4><p>向服务器推送数据：</p>
<p><code>rsync -auvrtzopgP --progress  /backup/ rsync_backup@172.16.1.41::backup --password-file=/etc/rsync.password</code></p>
<p>或者</p>
<p><code>rsync -auvrtzopgP --progress  /backup/ rsync://rsync_backup@172.16.1.41/backup --password-file=/etc/rsync.password</code></p>
<p>从服务器拉回数据</p>
<p><code>rsync -avz   rsync_backup@172.16.1.41::backup /backup/ --password-file=/etc/rsync.password</code></p>
<p>或者</p>
<p><code>rsync -avz   rsync://rsync_backup@172.16.1.41/backup  /backup/ --password-file=/etc/rsync.password</code></p>
<h3 id="小结">小结</h3><p>配置步骤回顾</p>
<blockquote>
<p>查看rsync 安装包&gt;&gt;  添加rsync用户 &gt;&gt;  生成配置文件 &gt;&gt;   配置账户，密码文件 &gt;&gt;  密码文件配置权限 600  &gt;&gt;  创建共享的目录并授权rsync &gt;&gt;启动rsync  <code>rsync --daemon</code> &gt;&gt; 开机启动<br>排错小结：查看推送或者拉取报错信息， 查看日志 <code>tail /var/log/rsyncd.log</code></p>
</blockquote>
<p>重启rsync就必须杀掉进程</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@backup</span> backup]<span class="variable">$ </span>kill <span class="string">`cat /var/run/rsyncd.pid`</span></span><br><span class="line">[root<span class="variable">@backup</span> backup]<span class="variable">$ </span>lsof -i <span class="symbol">:</span><span class="number">873</span></span><br><span class="line">[root<span class="variable">@backup</span> backup]<span class="variable">$ </span>pkill rsync</span><br><span class="line">[root<span class="variable">@backup</span> backup]<span class="variable">$ </span>killall rsync</span><br></pre></td></tr></table></figure>
<p>rsync 优点</p>
<ol>
<li>增量备份， 支持socket 集中备份，（支持推拉，都是以客户端参照物）</li>
<li>远程shell 通道模式还可以加密(ssh) 传输 。 socket 需要加密传输，可以利用vpn 服务或ipsec服务</li>
</ol>
<p>rsync 缺点</p>
<ol>
<li>大量小文件时候同步的时候，比对时间长，有的时候，rsync进程可能会停止</li>
<li>同步大文件，10G 这样的大文件有时也会问题，中断。 未完整同步前，是隐藏文件</li>
</ol>
<p>实战作业：<br>5.1.4.2 备份全网服务器数据生产架构方案案例模型<br>企业案例：rsync上机实战考试题：<br>某公司里有一台Web服务器，里面的数据很重要，但是如果硬盘坏了，数据就会丢失，现在领导要求你把数据在其他机器上做一个周期性定时备份。要求如下：<br>每天晚上00点整在Web服务器A上打包备份网站程序目录并通过rsync命令推送到服务器B上备份保留（备份思路可以是先在本地按日期打包，然后再推到备份服务器上）。<br>具体要求如下：<br>1)Web服务器A和备份服务器B的备份目录必须都为/backup。<br>2)Web服务器站点目录假定为(/var/www/html)。<br>3)Web服务器本地仅保留7天内的备份。<br>4)备份服务器上检查备份结果是否正常，并将每天的备份结果发给管理员信箱（选做）。<br>5)备份服务器上每周六的数据都保留，其他备份仅保留180天备份（选做）。</p>
<p>拔锚必备思想：<br>部署流程步骤熟练<br>rsync原理理解</p>
<h2 id="crontab_+_rsync_定时推送">crontab + rsync 定时推送</h2><p>定时任务一般都新建一个目录专门用来存放定时任务的sh.我一般呢会存放在<strong>/server/scripts/</strong>目录下面。 新建一个sh 命名为rsync.dailyBackup.sh. 增加好下内容</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ cat rsync.dailyBackup.sh</span><br><span class="line">#! /bin/sh</span><br><span class="line"># backup /backup  to 172.16.1.41:/backup</span><br><span class="line">path=/backup</span><br><span class="line">hostn=$(hostname)</span><br><span class="line">dir=$&#123;hostn&#125;-172.16.1.31</span><br><span class="line">ldate=$(date +%F)</span><br><span class="line">mkdir  $&#123;path&#125;/$&#123;dir&#125; &amp;&amp;\</span><br><span class="line">/bin/cp /etc/rc.local $&#123;path&#125;/$&#123;dir&#125;/rc.local_$&#123;ldate&#125; &amp;&amp;\</span><br><span class="line">rsync -az $&#123;path&#125;/ rsync_backup@172.16.1.41::backup/ --password-file=/etc/rsync.password</span><br></pre></td></tr></table></figure>
<p>首先测试是否成功执行任务，并推送到rsync服务器。然后便写入crontab </p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>crontab -l</span><br><span class="line"><span class="comment">#######time sync by lzy at 2015-11-02</span></span><br><span class="line">*<span class="regexp">/5 * * * * /usr</span><span class="regexp">/sbin/ntpdate</span> time.nist.gov &gt;<span class="regexp">/dev/null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">####rsync by lzy at 2015-11-07</span></span><br><span class="line"><span class="number">00</span> <span class="number">01</span> * * * <span class="regexp">/bin/sh</span> /server/scripts/rsync.sh &gt;<span class="regexp">/dev/null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br></pre></td></tr></table></figure>
<h2 id="实时同步">实时同步</h2><p>inotify+rsync<br>inotify 是一种强大的细粒度的，异步的文件系统事件监控机制， linux内核从2.6.13起，加入了inotify支持。其本身没有推送的功能，只 有监控文件系统的任务. 我们可以用inotify + rsync 做到实时复制，但是<br>sersync 国人周洋编辑的<br>inotify + rsync 实时复制  osersync<br>每秒只能同步200张100K的图片  可以用drbd （备节点不可用）  双协</p>
<p>查看系统是否支持inotify，如果没有下列文件便表示不支持</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$ </span>ll /proc/sys/fs/inotify/</span><br><span class="line">total <span class="number">0</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> <span class="constant">Nov</span>  <span class="number">9</span> <span class="number">17</span><span class="symbol">:</span><span class="number">39</span> max_queued_events</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> <span class="constant">Nov</span>  <span class="number">9</span> <span class="number">17</span><span class="symbol">:</span><span class="number">39</span> max_user_instances</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">0</span> <span class="constant">Nov</span>  <span class="number">9</span> <span class="number">17</span><span class="symbol">:</span><span class="number">39</span> max_user_watches</span><br></pre></td></tr></table></figure>
<ul>
<li>max_queued_events,表示调用inotify_init时分配给inotify instance中可排队的event的数目的最大值，超出这值的事件被丢弃，触发IN_Q_OVERFLOW事件</li>
<li>max_user_instances 每一个user ID可创建的inotify instatnces的数量上限</li>
<li>max_user_watches表示每个inotify instatnces可监控的最大目录数量。</li>
</ul>
<p>安装inotify-tools<br>方法一</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="variable">$ </span>rpm -ivh /apps/crm/soft_src/inotify-tools-<span class="number">3.14</span>-<span class="number">1</span>.el6.x86_64.rpm </span><br><span class="line"><span class="symbol">warning:</span> /apps/crm/soft_src/inotify-tools-<span class="number">3.14</span>-<span class="number">1</span>.el6.x86_64.<span class="symbol">rpm:</span> <span class="constant">Header</span> <span class="constant">V3</span> <span class="constant">DSA</span>/<span class="constant">SHA1</span> <span class="constant">Signature</span>, key <span class="constant">ID</span> <span class="number">4026433</span><span class="symbol">f:</span> <span class="constant">NOKEY</span></span><br><span class="line"><span class="constant">Preparing</span>...                <span class="comment">########################################### [100%]</span></span><br><span class="line">   <span class="number">1</span><span class="symbol">:inotify-tools</span>          <span class="comment">########################################### [100%]</span></span><br><span class="line"><span class="variable">$ </span>rpm -qa|grep inotify</span><br><span class="line">inotify-tools-<span class="number">3.14</span>-<span class="number">1</span>.el5.x86_64</span><br></pre></td></tr></table></figure>
<p>方法二</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget http://github.com/downloads/rvoicilas/inotify-tools/inotify-tools-3.14.tar.gz</span><br><span class="line">tar zxvf inotify-tools-3.14.tar.gz</span><br><span class="line">cd inotify-tools-3.14</span><br><span class="line">./configure --prefix=/usr/local/inotify</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<h3 id="inotifywait_介绍">inotifywait 介绍</h3><p>如果文件或者目录变更，那么就会调用inotify命令。是一个非常高效的工具。<br>其语法格式是</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inotifywait [-hcmrq] [-e &lt;event&gt; ] [-t &lt;seconds&gt; ] [--format &lt;fmt&gt; ] [--timefmt &lt;fmt&gt; ] &lt;file&gt; [ ... ]</span><br></pre></td></tr></table></figure>
<p>参数：</p>
<ul>
<li>-m  监听</li>
<li>-r, –recursive 递归监控</li>
<li>-q, –quiet，不输出信息</li>
<li>–exclude <pattern\></pattern\></li>
<li>-e <event\>, –event <event\><ul>
<li>delete ,create,close_write,modify </li>
</ul>
</event\></event\></li>
<li>–timefmt <fmt> 设置一个时间样式</fmt></li>
</ul>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">inotifywait -mrq --timefmt <span class="string">'%d/%m/%y %H:%M'</span> --format <span class="string">'%T %w %f'</span> -e create /backup  </span><br><span class="line">inotifywait -mrq --timefmt <span class="string">'%d/%m/%y %H:%M'</span> --format <span class="string">'%T %w %f'</span> -e create,delete,close_write /backup</span><br></pre></td></tr></table></figure>
<p>执行第二个命令后的结果格式结果是</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">47</span> /backup/ a</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">47</span> /backup/ a</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">47</span> /backup/ a.txt</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">47</span> /backup/ a.txt</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">47</span> /backup/ .test.txt.swp</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">47</span> /backup/ .test.txt.swx</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">47</span> /backup/ .test.txt.swx</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">47</span> /backup/ .test.txt.swx</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">47</span> /backup/ .test.txt.swp</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">47</span> /backup/ .test.txt.swp</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">47</span> /backup/ .test.txt.swp</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">48</span> /backup/ test.txt</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">48</span> /backup/ test.txt</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">48</span> /backup/ .test.txt.swp</span><br><span class="line">09/<span class="number">11</span>/<span class="number">15</span> <span class="number">17</span><span class="symbol">:</span><span class="number">48</span> /backup/ .test.txt.swp</span><br></pre></td></tr></table></figure>
<p>刚才注意到 创建一个文件产生的临时文件也都会被记录下来。而且还有重复。为了同步时减少带宽与CPU消耗，就需要使用排除，来排除指定的文件。排除一般有两种方法：1，使用rsync排除; 2,使用inotify排除，同时加入rsync排除,我们一般使用第二种<br>inotifywati排队监控目录有 –exclude <pattern\> –formfile <file\> 前面可以用正则，后者只能是具体的目录或文件</file\></pattern\></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi inotify_exclude.lst</span><br><span class="line">/tmp/src/pdf</span><br><span class="line">@/tmp/src/<span class="number">2014</span></span><br></pre></td></tr></table></figure>
<p>–formfile 的file只能使用绝对路径，@表示排除。<br>用正则排除 </p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--exclude <span class="string">'(.*/*\.log|.*/*\.swp)$|^/tmp/src/mail/(2014|201.*/cache.*)'</span></span><br></pre></td></tr></table></figure>
<p>正则很明子了吧。 排除所有目录下以<strong>.log</strong>, <strong>.swp</strong> 结尾的文件，和所有在/tmp/src/mail下面2014这个目录和201*目录下的cache开头的文件或目录<br>在rsync里排除，这里指定file排除时用相对路径。</p>
<p>写一个角本<strong>inotifywait.sh</strong>放到backup目录下面,执行便可以实时同步，以下是几个版本<br>粗糙版，每次都会让rsync比对所有文件然后再同步</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /bin/bash</span></span><br><span class="line">/usr/bin/inotifywait -mrq  --format <span class="string">'%w%f'</span> -e create,close_write,delete /backup | \</span><br><span class="line"><span class="keyword">while</span> read file</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  	cd /backup &amp;&amp; \</span><br><span class="line">  	rsync -az ./ --delete rsync_backup<span class="variable">@172</span>.<span class="number">16.1</span>.<span class="number">41</span><span class="symbol">:</span><span class="symbol">:backup</span> --password-file=<span class="regexp">/etc/rsync</span>.password</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>精准版</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /bin/sh</span></span><br><span class="line"><span class="constant">FullPath</span>=<span class="string">"/usr/bin/inotifywait"</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$&#123;</span><span class="constant">FullPath</span>&#125; -mrq --format <span class="string">'%w%f'</span> -e create,close_write,delete /backup | \</span><br><span class="line">	<span class="keyword">while</span> read <span class="constant">Line</span></span><br><span class="line">	<span class="keyword">do</span></span><br><span class="line">  	[ ! -e  <span class="string">"$line"</span> ]  &amp;&amp;\</span><br><span class="line">  rsync -az --delete ./ rsync_backup<span class="variable">@172</span>.<span class="number">16.1</span>.<span class="number">41</span><span class="symbol">:</span><span class="symbol">:backup</span> --password-file=<span class="regexp">/etc/rsync</span>.password &amp;&amp; \</span><br><span class="line">	continue</span><br><span class="line">  rsync -az --delete <span class="variable">$&#123;</span><span class="constant">Line</span>&#125; rsync_backup<span class="variable">@172</span>.<span class="number">16.1</span>.<span class="number">41</span><span class="symbol">:</span><span class="symbol">:backup</span> --password-file=<span class="regexp">/etc/rsync</span>.password</span><br><span class="line">	done</span><br></pre></td></tr></table></figure>
<p>上面的是不是很简单，那么再来一个更全面的客户端配置文件</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#rsync auto sync script with inotify</span><br><span class="line">#2015-11-09 sandow</span><br><span class="line">#variables</span><br><span class="line">Current_date=$(date +%Y%m%d_%H%M%S)</span><br><span class="line">source_path=/backup/</span><br><span class="line">log_file=/var/log/rsync_client.log</span><br><span class="line">#rsync</span><br><span class="line">rsync_server=172.16.1.41</span><br><span class="line">rsync_user=rsync_backup</span><br><span class="line">rsync_pwd=/etc/rsync.password</span><br><span class="line">rsync_module=backup</span><br><span class="line">INOTIFY_EXCLUDE="(.*/*\.log|.*/*\.swp)$|^/tmp/src/mail/(2014|20.*/.*che.*)"</span><br><span class="line">RSYNC_EXCLUDE=/etc/rsyncd.d/rsync_exclude.lst</span><br><span class="line">#rsync client pwd check</span><br><span class="line">if [ ! -e $&#123;rsync_pwd&#125; ];then</span><br><span class="line">    echo -e "rsync client passwod file $&#123;rsync_pwd&#125; does not exist!"</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line">#inotify_function</span><br><span class="line">inotify_fun()&#123;</span><br><span class="line">    /usr/bin/inotifywait -mrq --timefmt '%Y/%m/%d-%H:%M:%S' --format '%T %w %f' \</span><br><span class="line">          --exclude $&#123;INOTIFY_EXCLUDE&#125;  -e modify,delete,create,move,attrib $&#123;source_path&#125; | \</span><br><span class="line">      while read file</span><br><span class="line">      do</span><br><span class="line">          /usr/bin/rsync -auvrtzopgP --exclude-from=$&#123;RSYNC_EXCLUDE&#125; --progress --bwlimit=200 --password-file=$&#123;rsync_pwd&#125; $&#123;source_path&#125; $&#123;rsync_user&#125;@$&#123;rsync_server&#125;::$&#123;rsync_module&#125; </span><br><span class="line">      done</span><br><span class="line">&#125;</span><br><span class="line">#inotify log</span><br><span class="line">inotify_fun &gt;&gt; $&#123;log_file&#125; 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<p>来点链接，深入研究的话可以上去查看 <br></p>
<blockquote>
<p><a href="https://rsync.samba.org/how-rsync-works.html" target="_blank" rel="external">How Rsync Works A Practical Overview</a> <br><br><a href="https://www.ibm.com/developerworks/cn/linux/l-inotify/" target="_blank" rel="external">用 inotify 监控 Linux 文件系统事件</a> <br><br><a href="http://www.infoq.com/cn/articles/inotify-linux-file-system-event-monitoring" target="_blank" rel="external">inotify: 高效、实时的Linux文件系统事件监控框架</a> <br><br><a href="http://coolshell.cn/articles/7425.html" target="_blank" rel="external">rsync 的核心算法</a></p>
</blockquote>
<h2 id="sersync">sersync</h2><p>听同事说 sersync 这么个工具可以提高同步的性能，也解决了同步大文件时出现异常的问题，所以就尝试了一下。sersync是国内的一个开发者开源出来的，使用c++编写，采用多线程的方式进行同步，失败后还有重传机制，对临时文件过滤，自带crontab定时同步功能。网上看到有人说性能还不错，但是我觉得：</p>
<p>国产开源，文档不是很全，在2011年之后就没更新了。采用xml配置文件的方式，可读性比较好，但是有些原生的有些功能没有实现就没法使用了。</p>
<p>无法实现多目录同步，只能通过多个配置文件启动多个进程，文件排除功能太弱。</p>
<p>虽然提供插件的功能，但很鸡肋，因为软件本身没有持续更新，也没有看到贡献有其它插件出现（可能是我知识面不够，还用不到里面的refreshCDN plugin）。虽然不懂c++，但大致看了下源码 FileSynchronize，拼接rsync命令大概在273行左右，最后一个函数就是排除选项，简单一点可以将–exclude=改成–eclude-from来灵活控制。有机会再改吧。</p>
<p>另外，在作者的文章 Sersync服务器同步程序 项目简介与设计框架 评论中，说能解决上面 rsync + inotify中所描述的问题。阅读了下源码，这个应该是没有解决，因为在拼接rsync命令时，后面的目的地址始终是针对module的，只要执行rsync命令，就会对整个目录进行遍历，发送要比对的文件列表，然后再发送变化的文件。sersync只是减少了监听的事件，减少了rsync的次数——这已经是很大的改进，但每次rsync没办法改变。（如有其它看法可与我讨论）</p>
<p>其实我们也不能要求每一个软件功能都十分健全，关键是看能否满足我们当下的特定的需求。所谓好的架构不是设计出来的，而是进化来的。目前使用sersync2没什么问题，而且看了它的设计思路应该是比较科学的，特别是过滤队列的设计。双向同步看起来也是可以实现。</p>
<h2 id="rsync常见错误与问题">rsync常见错误与问题</h2><p>Q：如何通过ssh进行rsync，而且无须输入密码？    </p>
<ul>
<li><p>可以通过以下几个步骤        </p>
<ol>
<li>通过ssh-keygen在server A上建立SSH keys，不要指定密码，你会在~/.ssh下看到identity和identity.pub文件 </li>
<li>在server B上的home目录建立子目录.ssh</li>
<li>将A的identity.pub拷贝到server B上</li>
<li>将identity.pub加到~[user b]/.ssh/authorized_keys</li>
<li>于是server A上的A用户，可通过下面命令以用户B ssh到server B上了。e.g. ssh -l userB serverB。这样就使server A上的用户A就可以ssh以用户B的身份无需密码登陆到server B上了。</li>
</ol>
</li>
</ul>
<p>Q：如何通过在不危害安全的情况下通过防火墙使用rsync?</p>
<ul>
<li>解答如下：<br>这通常有两种情况，一种是服务器在防火墙内，一种是服务器在防火墙外。无论哪种情况，通常还是使用ssh，这时最好新建一个备份用户，并且配置sshd 仅允许这个用户通过RSA认证方式进入。如果服务器在防火墙内，则最好限定客户端的IP地址，拒绝其它所有连接。如果客户机在防火墙内，则可以简单允许防 火墙打开TCP端口22的ssh外发连接就ok了。</li>
</ul>
<p>Q：我能将更改过或者删除的文件也备份上来吗？</p>
<ul>
<li>当然可 以。你可以使用如：rsync -other -options -backupdir = ./backup-2000-2-13  …这样的命令来实现。这样如果源文件:/path/to/some/file.c改变了，那么旧的文件就会被移到./backup- 2000-2-13/path/to/some/file.c，这里这个目录需要自己手工建立起来</li>
</ul>
<p>Q：我需要在防火墙上开放哪些端口以适应rsync？</p>
<ul>
<li>视情况而定。rsync可以直接通过873端口的tcp连接传文件，也可以通过22端口的ssh来进行文件传递，但你也可以通过下列命令改变它的端口：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ iptables -A INPUT -p tcp -m state --state NEW  -m tcp --dport <span class="number">873</span> -j ACCEPT</span><br></pre></td></tr></table></figure>
<p><code>rsync --port 8730 otherhost::</code>或者<code>rsync -e &#39;ssh -p 2002&#39; otherhost:</code></p>
<p>Q：我如何通过rsync只复制目录结构，忽略掉文件呢？    </p>
<ul>
<li><code>rsync -av --include &#39;*/&#39; --exclude &#39;*&#39; source-dir dest-dir</code></li>
</ul>
<p>Q：为什么我总会出现”Read-only file system”的错误呢？    </p>
<ul>
<li>看看是否忘了设”read only = no”了</li>
</ul>
<p>Q：为什么我会出现’@ERROR: invalid gid’的错误呢？</p>
<ul>
<li>rsync使用时默认是用uid=nobody;gid=nobody来运行的，如果你的系统不存在nobody组的话，就会出现这样的错误，可以试试gid = ogroup或者其它</li>
</ul>
<p>Q：绑定端口873失败是怎么回事？</p>
<ul>
<li>如果你不是以root权限运行这一守护进程的话，因为1024端口以下是特权端口，会出现这样的错误。你可以用–port参数来改变。</li>
</ul>
<p>Q：为什么我认证失败？    </p>
<ul>
<li>从你的命令行看来：你用的是</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bash$ rsync -a <span class="number">144.16</span><span class="number">.251</span><span class="number">.213</span>::test test</span><br><span class="line">Password:</span><br><span class="line"><span class="decorator">@ERROR: auth failed on module test</span></span><br></pre></td></tr></table></figure>
<p>应该是没有以你的用户名登陆导致的问题，试试rsync -a max@144.16.251.213::test test</p>
<p>Q: 出现以下这个讯息, 是怎么一回事?    </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="decorator">@ERROR: auth failed on module xxxxx</span></span><br><span class="line">rsync: connection unexpectedly closed (<span class="number">90</span> bytes read so far)</span><br><span class="line">rsync error: error <span class="keyword">in</span> rsync protocol data stream (code <span class="number">12</span>) at io.c(<span class="number">150</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>这是因为密码设错了, 无法登入成功, 请再检查一下 rsyncd.secrets 中的密码设定, 二端是否一致?</li>
</ul>
<p>Q: 出现以下这个讯息, 是怎么一回事?    </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">password file must <span class="keyword">not</span> be other-accessible </span><br><span class="line">continuing without password file </span><br><span class="line">Password:</span><br></pre></td></tr></table></figure>
<ul>
<li>这表示 rsyncd.secrets 的档案权限属性不对, 应设为 600。请下 chmod 600 rsyncd.secrets</li>
</ul>
<p>Q: 出现以下这个讯息, 是怎么一回事?</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="decorator">@ERROR: chroot failed</span></span><br><span class="line">rsync: connection unexpectedly closed (<span class="number">75</span> bytes read so far)</span><br><span class="line">rsync error: error <span class="keyword">in</span> rsync protocol data stream (code <span class="number">12</span>) at io.c(<span class="number">150</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>这通常是您的 rsyncd.conf 中的 path 路径所设的那个目录并不存在所致.请先用 mkdir开设好备份目录.</li>
</ul>
<p>高并发数据实时同步方案小结<br>1。inotify+rsync 文件级别<br>2。drbd 文件系统级别<br>3。 第三方软件的同步功能， mysql, oracle, mongodb<br>4.。 程序双写<br>5。业务逻辑解决。（读写分离，备读不到，读主）</p>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/linux/" rel="tag">#linux</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/regular-expressions/" rel="next" title="Regular Expressions">
                <i class="fa fa-chevron-left"></i> Regular Expressions
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/vim/" rel="prev" title="vim常用操作">
                vim常用操作 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_douban"></a>
  <a class="jiathis_button_renren"></a>
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_kaixin001"></a>
  <a class="jiathis_button_copy"></a>
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      
    </div>
  </div>


        </div>

        


        
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="inotify_rsync/"
           data-title="rsync + inotify 实现实时同步" data-url="gsandow.github.io/inotify_rsync/">
      </div>
    
  </div>


      </div>

      
        
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            本站概覽
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="/images/avatar.jpg" alt="sandow" itemprop="image"/>
          <p class="site-author-name" itemprop="name">sandow</p>
        </div>
        <p class="site-description motion-element" itemprop="description">博學   慎思   笃行</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">7</span>
              <span class="site-state-item-name">文章</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">3</span>
              <span class="site-state-item-name">分類</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">6</span>
              <span class="site-state-item-name">標籤</span>
              </a>
          </div>

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="http://github.com/gsandow" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/jkshiqiao" target="_blank">
                  
                    <i class="fa fa-weibo"></i> Weibo
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.douban.com/people/gsandow/" target="_blank">
                  
                    <i class="fa fa-douban"></i> Douban
                  
                </a>
              </span>
            
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
            <p class="site-author-name">Links</p>
            
              <span class="links-of-author-item">
                <a href="http://coursera.org/" target="_blank">Coursera</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.edx.org" target="_blank">edx</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.52nlp.cn/" target="_blank">52nlp</a>
              </span>
            
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#主机规划"><span class="nav-number">1.</span> <span class="nav-text">主机规划</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#克隆虚拟机并配置网卡"><span class="nav-number">1.1.</span> <span class="nav-text">克隆虚拟机并配置网卡</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RSYNC_数据库服务器"><span class="nav-number">1.2.</span> <span class="nav-text">RSYNC 数据库服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#本地备份"><span class="nav-number">1.2.1.</span> <span class="nav-text">本地备份</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通过shell远程传输(remote)"><span class="nav-number">1.2.2.</span> <span class="nav-text">通过shell远程传输(remote)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#daemon_模式，"><span class="nav-number">1.2.3.</span> <span class="nav-text">daemon 模式，</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#服务端的配置"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">服务端的配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#客户端的配置"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">客户端的配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#备份数据以及自动备份"><span class="nav-number">1.2.3.3.</span> <span class="nav-text">备份数据以及自动备份</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#小结"><span class="nav-number">1.2.4.</span> <span class="nav-text">小结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#crontab_+_rsync_定时推送"><span class="nav-number">1.3.</span> <span class="nav-text">crontab + rsync 定时推送</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实时同步"><span class="nav-number">1.4.</span> <span class="nav-text">实时同步</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#inotifywait_介绍"><span class="nav-number">1.4.1.</span> <span class="nav-text">inotifywait 介绍</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sersync"><span class="nav-number">1.5.</span> <span class="nav-text">sersync</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rsync常见错误与问题"><span class="nav-number">1.6.</span> <span class="nav-text">rsync常见错误与问题</span></a></li></ol></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


      
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2015</span>
  <span class="with-love">
    <i class="icon-next-heart fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sandow</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    sandow
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"magdre"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     


    
  

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.2"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.2"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
<script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

<script type="text/javascript" src="/js/motion.js?v=0.4.5.2" id="motion.global"></script>


  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.2" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    motionMiddleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');
      if (CONFIG.sidebar === 'post') {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          displaySidebar();
        }
      }
    };
  });
</script>



  <script type="text/javascript" src="/js/bootstrap.js"></script>

  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>

  
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  
  

</body>
</html>
